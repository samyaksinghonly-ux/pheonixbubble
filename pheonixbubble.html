<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Phoenix Fire ‚Äî Rise from the Ashes</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700;900&family=Cinzel:wght@400;600;700&family=Rajdhani:wght@300;400;500;600;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --fire1:#ff2200;--fire2:#ff6600;--fire3:#ffaa00;--gold:#ffd700;
  --ash:#1a1008;--deep:#080401;--smoke:#2a1f10;
  --glow-orange:rgba(255,100,0,0.6);--glow-gold:rgba(255,215,0,0.4);
}
html,body{width:100%;height:100%;overflow:hidden;background:#000;cursor:none}
#cursor{position:fixed;pointer-events:none;z-index:9999;mix-blend-mode:screen}
#cursor-ring{width:24px;height:24px;border:2px solid rgba(255,150,50,0.8);border-radius:50%;position:absolute;transform:translate(-50%,-50%);transition:transform 0.1s;box-shadow:0 0 10px var(--fire2)}
#cursor-dot{width:6px;height:6px;background:#fff;border-radius:50%;position:absolute;transform:translate(-50%,-50%);box-shadow:0 0 8px #ffd700}

/* ====== PRESENTATION ====== */
#presentation{position:fixed;inset:0;z-index:100;perspective:1200px}
.slide{position:absolute;inset:0;opacity:0;pointer-events:none;transform:rotateY(15deg) scale(0.95);transition:opacity 0.7s cubic-bezier(.4,0,.2,1),transform 0.7s cubic-bezier(.4,0,.2,1);will-change:transform,opacity}
.slide.active{opacity:1;pointer-events:all;transform:rotateY(0deg) scale(1)}
#nav{position:fixed;bottom:2.5rem;left:50%;transform:translateX(-50%);z-index:500;display:flex;align-items:center;gap:1rem;background:rgba(5,2,0,0.85);backdrop-filter:blur(20px);border:1px solid rgba(255,100,0,0.25);border-radius:60px;padding:1rem 2rem;box-shadow:0 0 40px rgba(255,80,0,0.2)}
.ndot{width:8px;height:8px;border-radius:50%;background:rgba(255,100,0,0.2);border:1px solid rgba(255,100,0,0.5);cursor:pointer;transition:all 0.3s}
.ndot.on{background:var(--fire2);box-shadow:0 0 12px var(--fire2);transform:scale(1.4)}
.nbtn{font-family:'Rajdhani',sans-serif;font-weight:700;font-size:0.8rem;letter-spacing:0.15em;padding:0.5rem 1.4rem;border-radius:30px;border:none;cursor:pointer;transition:all 0.25s;text-transform:uppercase}
.nbtn.prev{background:transparent;color:var(--fire2);border:1px solid rgba(255,100,0,0.4)}
.nbtn.prev:hover{background:rgba(255,100,0,0.1);border-color:var(--fire2)}
.nbtn.next{background:linear-gradient(135deg,var(--fire1),var(--fire2));color:#fff}
.nbtn.next:hover{filter:brightness(1.3);transform:scale(1.05)}
#s1{background:#000;display:flex;align-items:center;justify-content:center;flex-direction:column;text-align:center;overflow:hidden}
#s1-bg{position:absolute;inset:0;background:radial-gradient(ellipse 80% 60% at 50% 90%,rgba(255,60,0,0.35) 0%,rgba(255,30,0,0.08) 50%,transparent 70%)}
#lava-canvas{position:absolute;inset:0;opacity:0.4}
.s1-title{font-family:'Cinzel Decorative',serif;font-size:clamp(3.5rem,9vw,8rem);font-weight:900;line-height:0.95;background:linear-gradient(170deg,#fff8e0 0%,#ffd700 25%,#ff8c00 55%,#ff2200 85%,#800000 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;filter:drop-shadow(0 0 60px rgba(255,120,0,0.5));animation:titleBreath 4s ease-in-out infinite alternate;position:relative;z-index:2;letter-spacing:0.02em}
@keyframes titleBreath{0%{filter:drop-shadow(0 0 30px rgba(255,120,0,0.4))}100%{filter:drop-shadow(0 0 80px rgba(255,180,0,0.8))}}
.s1-sub{font-family:'Cinzel',serif;font-size:clamp(0.8rem,2vw,1.3rem);letter-spacing:0.5em;color:rgba(255,200,100,0.7);margin-top:1.5rem;text-transform:uppercase;position:relative;z-index:2}
.s1-divider{width:200px;height:1px;background:linear-gradient(90deg,transparent,var(--fire2),transparent);margin:1.5rem auto;position:relative;z-index:2}
.s1-tagline{font-family:'Rajdhani',sans-serif;font-size:1.1rem;color:rgba(255,150,80,0.5);letter-spacing:0.25em;position:relative;z-index:2}
.s1-scroll{position:absolute;bottom:8rem;color:rgba(255,100,50,0.4);font-family:'Rajdhani',sans-serif;font-size:0.8rem;letter-spacing:0.3em;animation:bounce 2s infinite;z-index:2}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(6px)}}
.fire-bar{position:absolute;bottom:0;left:0;right:0;height:120px;background:linear-gradient(0deg,rgba(255,40,0,0.4),transparent);z-index:2}
#s2{background:linear-gradient(135deg,#080c08 0%,#0a0f1a 50%,#100808 100%);display:flex;align-items:center;justify-content:center}
.s2-grid{display:grid;grid-template-columns:1fr 1fr;gap:0;max-width:1200px;width:100%;height:80vh;align-items:center}
.s2-left{padding:4rem;border-right:1px solid rgba(255,100,0,0.15)}
.s2-right{padding:4rem;display:flex;flex-direction:column;gap:1.5rem}
.slide-tag{display:inline-block;font-family:'Rajdhani',sans-serif;font-size:0.75rem;letter-spacing:0.35em;color:var(--fire2);text-transform:uppercase;border:1px solid rgba(255,100,0,0.4);padding:0.3rem 0.8rem;border-radius:3px;margin-bottom:1.5rem;background:rgba(255,100,0,0.05)}
.slide-h1{font-family:'Cinzel',serif;font-size:clamp(2rem,4vw,3.5rem);font-weight:700;color:#fff;line-height:1.1;margin-bottom:1.5rem}
.slide-h1 span{background:linear-gradient(90deg,var(--fire2),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.slide-p{font-family:'Rajdhani',sans-serif;font-size:1.05rem;color:rgba(255,220,180,0.6);line-height:1.8;font-weight:400}
.concept-card{background:rgba(255,255,255,0.02);border:1px solid rgba(255,100,0,0.12);border-radius:12px;padding:1.5rem;transition:all 0.3s;position:relative;overflow:hidden}
.concept-card::before{content:'';position:absolute;left:0;top:0;width:3px;height:0;background:linear-gradient(180deg,var(--fire2),var(--gold));transition:height 0.4s}
.concept-card:hover{border-color:rgba(255,100,0,0.4);background:rgba(255,100,0,0.04);transform:translateX(6px)}
.concept-card:hover::before{height:100%}
.cc-icon{font-size:1.8rem;margin-bottom:0.6rem}
.cc-title{font-family:'Cinzel',serif;font-size:1rem;color:var(--gold);margin-bottom:0.4rem}
.cc-text{font-family:'Rajdhani',sans-serif;font-size:0.9rem;color:rgba(255,220,180,0.55);line-height:1.5}
#s3{background:linear-gradient(160deg,#05070a 0%,#0a0500 100%);display:flex;align-items:center;justify-content:center}
.s3-inner{max-width:1100px;width:100%;padding:3rem}
.mech-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1.2rem;margin-top:2rem}
.mcard{background:rgba(0,0,0,0.4);border:1px solid rgba(255,100,0,0.1);border-radius:16px;padding:2rem;position:relative;overflow:hidden;transition:all 0.35s;cursor:default}
.mcard:hover{border-color:rgba(255,150,0,0.5);background:rgba(255,80,0,0.06);transform:translateY(-4px);box-shadow:0 20px 60px rgba(255,80,0,0.15)}
.mcard-glow{position:absolute;width:200px;height:200px;border-radius:50%;background:radial-gradient(circle,rgba(255,100,0,0.12) 0%,transparent 70%);top:-50px;right:-50px;transition:opacity 0.3s;opacity:0}
.mcard:hover .mcard-glow{opacity:1}
.mcard-num{position:absolute;top:1.5rem;right:1.5rem;font-family:'Cinzel',serif;font-size:3rem;color:rgba(255,100,0,0.1);font-weight:900;line-height:1}
.mcard-icon{font-size:2.2rem;margin-bottom:1rem;display:block}
.mcard-title{font-family:'Cinzel',serif;font-size:1.2rem;color:var(--fire3);margin-bottom:0.6rem}
.mcard-desc{font-family:'Rajdhani',sans-serif;font-size:0.95rem;color:rgba(255,220,180,0.55);line-height:1.6}
#s4{background:#040302;display:flex;align-items:center;justify-content:center}
.s4-inner{max-width:1100px;width:100%;padding:3rem}
.color-journey{display:flex;align-items:stretch;gap:0;margin-top:2rem;border-radius:16px;overflow:hidden;height:220px;border:1px solid rgba(255,100,0,0.15)}
.cj-phase{flex:1;display:flex;flex-direction:column;justify-content:flex-end;padding:1.5rem;position:relative;transition:flex 0.5s}
.cj-phase:hover{flex:2}
.cj-phase .label{font-family:'Cinzel',serif;font-size:0.9rem;color:rgba(255,255,255,0.8);position:relative;z-index:1}
.cj-phase .sublabel{font-family:'Rajdhani',sans-serif;font-size:0.75rem;color:rgba(255,255,255,0.4);position:relative;z-index:1;letter-spacing:0.15em;text-transform:uppercase}
.phase-ash{background:linear-gradient(180deg,#111 0%,#222 100%)}
.phase-ember{background:linear-gradient(180deg,#1a0800 0%,#4a1500 100%)}
.phase-flame{background:linear-gradient(180deg,#3a0800 0%,#ff3300 100%)}
.phase-gold{background:linear-gradient(180deg,#2a1500 0%,#ff8800 50%,#ffd700 100%)}
.style-cards{display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;margin-top:1.5rem}
.scard{background:rgba(255,255,255,0.02);border:1px solid rgba(255,100,0,0.1);border-radius:10px;padding:1.2rem;text-align:center}
.scard-icon{font-size:1.8rem;margin-bottom:0.5rem}
.scard-t{font-family:'Cinzel',serif;font-size:0.85rem;color:var(--fire3);margin-bottom:0.3rem}
.scard-d{font-family:'Rajdhani',sans-serif;font-size:0.8rem;color:rgba(255,200,150,0.4);line-height:1.4}
#s5{background:radial-gradient(ellipse at 50% 50%,#120500 0%,#000 80%);display:flex;align-items:center;justify-content:center}
.s5-inner{max-width:1000px;width:100%;padding:3rem;display:grid;grid-template-columns:1fr 1fr;gap:4rem;align-items:center}
.orbit-wrap{position:relative;width:360px;height:360px;margin:0 auto}
.orbit-ring1{position:absolute;inset:0;border-radius:50%;border:1px solid rgba(255,100,0,0.2);animation:orb1 15s linear infinite}
.orbit-ring2{position:absolute;inset:30px;border-radius:50%;border:1px solid rgba(255,150,0,0.15);animation:orb1 10s linear infinite reverse}
@keyframes orb1{from{transform:rotate(0)}to{transform:rotate(360deg)}}
.orbit-center{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;text-align:center}
.orbit-logo{font-family:'Cinzel Decorative',serif;font-size:1.5rem;color:var(--fire2);margin-bottom:0.3rem}
.orbit-sub{font-family:'Rajdhani',sans-serif;font-size:0.85rem;color:rgba(255,150,80,0.5);letter-spacing:0.2em}
.member-node{position:absolute;background:rgba(15,8,0,0.95);border:1px solid rgba(255,100,0,0.4);border-radius:10px;padding:0.6rem 1.2rem;font-family:'Cinzel',serif;font-size:0.85rem;color:#ffd700;white-space:nowrap;box-shadow:0 0 20px rgba(255,80,0,0.2)}
.mn1{top:0;left:50%;transform:translateX(-50%) translateY(-50%)}
.mn2{right:0;top:50%;transform:translateX(50%) translateY(-50%)}
.mn3{bottom:0;left:50%;transform:translateX(-50%) translateY(50%)}
.mn4{left:0;top:50%;transform:translateX(-50%) translateY(-50%)}
.s5-right{display:flex;flex-direction:column;gap:1rem}
.play-btn{background:linear-gradient(135deg,#ff1a00,#ff7700);border:none;color:#fff;font-family:'Cinzel',serif;font-size:1.4rem;font-weight:700;padding:1.2rem 3rem;border-radius:60px;cursor:pointer;letter-spacing:0.1em;animation:playPulse 2.5s ease infinite;transition:transform 0.2s,filter 0.2s;margin-top:1rem;width:100%}
.play-btn:hover{transform:scale(1.06) translateY(-2px);filter:brightness(1.3);box-shadow:0 20px 60px rgba(255,80,0,0.6)}
@keyframes playPulse{0%,100%{box-shadow:0 0 20px rgba(255,80,0,0.3),0 0 0 0 rgba(255,80,0,0.4)}50%{box-shadow:0 0 40px rgba(255,80,0,0.6),0 0 0 15px rgba(255,80,0,0)}}
.stat-row{display:flex;gap:1rem}
.stat-box{flex:1;background:rgba(255,100,0,0.06);border:1px solid rgba(255,100,0,0.15);border-radius:10px;padding:1rem;text-align:center}
.stat-num{font-family:'Cinzel',serif;font-size:1.8rem;color:var(--fire2)}
.stat-label{font-family:'Rajdhani',sans-serif;font-size:0.75rem;color:rgba(255,150,80,0.5);letter-spacing:0.15em;text-transform:uppercase}

/* ====== CHARACTER SELECT ====== */
#char-select{position:fixed;inset:0;background:radial-gradient(ellipse at 50% 30%,#1a0800 0%,#000 100%);z-index:150;display:none;flex-direction:column;align-items:center;justify-content:center;font-family:'Cinzel',serif}
.cs-title{font-family:'Cinzel Decorative',serif;font-size:clamp(2rem,5vw,3.5rem);background:linear-gradient(135deg,#fff,#ffd700,#ff6600);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:0.5rem;text-align:center}
.cs-sub{font-family:'Rajdhani',sans-serif;font-size:1rem;color:rgba(255,180,100,0.5);letter-spacing:0.3em;margin-bottom:2.5rem;text-align:center}
.cs-cards{display:flex;gap:1.5rem;justify-content:center;flex-wrap:wrap}
.cs-card{width:220px;background:rgba(10,5,0,0.85);border:2px solid rgba(255,100,0,0.2);border-radius:18px;padding:1.8rem 1.5rem;cursor:pointer;transition:all 0.35s;text-align:center;position:relative;overflow:hidden}
.cs-card::before{content:'';position:absolute;inset:0;opacity:0;transition:opacity 0.35s;border-radius:16px}
.cs-card.phoenix-card::before{background:radial-gradient(circle at 50% 50%,rgba(255,150,0,0.12),transparent 70%)}
.cs-card.assassin-card::before{background:radial-gradient(circle at 50% 50%,rgba(200,0,255,0.12),transparent 70%)}
.cs-card.titan-card::before{background:radial-gradient(circle at 50% 50%,rgba(255,50,0,0.12),transparent 70%)}
.cs-card:hover::before,.cs-card.selected::before{opacity:1}
.cs-card:hover,.cs-card.selected{transform:translateY(-8px) scale(1.04);border-color:rgba(255,150,0,0.7);box-shadow:0 20px 60px rgba(255,80,0,0.25)}
.cs-card.selected{border-color:#ffd700;box-shadow:0 0 30px rgba(255,215,0,0.4)}
.cs-icon{font-size:3.5rem;margin-bottom:0.8rem;display:block}
.cs-name{font-family:'Cinzel',serif;font-size:1.2rem;color:#ffd700;margin-bottom:0.5rem}
.cs-role{font-family:'Rajdhani',sans-serif;font-size:0.8rem;letter-spacing:0.2em;color:rgba(255,150,80,0.6);text-transform:uppercase;margin-bottom:1rem}
.cs-stat{display:flex;align-items:center;gap:0.5rem;margin:0.3rem 0;font-family:'Rajdhani',sans-serif;font-size:0.85rem}
.cs-stat-lbl{color:rgba(255,200,150,0.5);width:60px;text-align:left;font-size:0.75rem}
.cs-bar{flex:1;height:5px;background:rgba(255,255,255,0.08);border-radius:3px;overflow:hidden}
.cs-bar-fill{height:100%;border-radius:3px;transition:width 0.5s}
.phoenix-bar{background:linear-gradient(90deg,#ff6600,#ffd700)}
.assassin-bar{background:linear-gradient(90deg,#aa00ff,#ff44ff)}
.titan-bar{background:linear-gradient(90deg,#ff1100,#ff6600)}
.cs-passive{margin-top:1rem;font-family:'Rajdhani',sans-serif;font-size:0.8rem;color:rgba(255,180,100,0.55);line-height:1.5;border-top:1px solid rgba(255,100,0,0.1);padding-top:0.8rem}
.cs-passive strong{color:rgba(255,215,0,0.8)}
.cs-play-btn{margin-top:2rem;background:linear-gradient(135deg,#ff2200,#ff7700);border:none;color:#fff;font-family:'Cinzel',serif;font-size:1.1rem;font-weight:700;padding:0.9rem 3rem;border-radius:50px;cursor:pointer;letter-spacing:0.1em;transition:all 0.25s}
.cs-play-btn:hover{filter:brightness(1.25);transform:scale(1.05)}

/* ====== GAME ====== */
#game{position:fixed;inset:0;display:none}
#gc{position:absolute;inset:0;display:block}
#hud{position:fixed;inset:0;pointer-events:none;z-index:50;font-family:'Rajdhani',sans-serif}
.hud-tl{position:absolute;top:1.5rem;left:1.5rem;display:flex;flex-direction:column;gap:0.8rem}
.hud-tr{position:absolute;top:1.5rem;right:1.5rem;text-align:right}
.hud-bc{position:absolute;bottom:1.5rem;left:50%;transform:translateX(-50%);text-align:center}
.hud-panel{background:rgba(5,2,0,0.75);backdrop-filter:blur(12px);border:1px solid rgba(255,100,0,0.2);border-radius:10px;padding:0.7rem 1.1rem}
.hud-lbl{font-size:0.65rem;letter-spacing:0.25em;color:rgba(255,120,50,0.6);text-transform:uppercase;margin-bottom:0.3rem}
.hud-val{font-family:'Cinzel',serif;font-size:1.5rem;color:#ffd700;line-height:1}
.ebar-wrap{width:180px;height:6px;background:rgba(255,255,255,0.08);border-radius:3px;overflow:visible;position:relative}
.ebar{height:100%;background:linear-gradient(90deg,#ff1100,#ff6600,#ffcc00);border-radius:3px;transition:width 0.08s;box-shadow:0 0 10px rgba(255,100,0,0.7)}
.ebar-glow{position:absolute;top:-3px;bottom:-3px;right:0;width:4px;background:#fff;border-radius:2px;box-shadow:0 0 8px #ffd700;transition:right 0.08s}
.hpbar-wrap{width:180px;height:6px;background:rgba(255,255,255,0.08);border-radius:3px;overflow:visible;position:relative;margin-top:0.4rem}
.hpbar{height:100%;background:linear-gradient(90deg,#cc0000,#ff3300,#ff6644);border-radius:3px;transition:width 0.08s;box-shadow:0 0 10px rgba(255,50,0,0.7)}
.combo-display{font-family:'Cinzel Decorative',serif;font-size:2rem;color:var(--fire2);text-shadow:0 0 20px var(--fire2);transition:all 0.15s;opacity:0;transform:scale(0.8)}
.combo-display.show{opacity:1;transform:scale(1)}
.power-badge{display:inline-block;background:rgba(255,100,0,0.15);border:1px solid rgba(255,150,0,0.3);border-radius:5px;padding:0.2rem 0.5rem;font-size:0.75rem;color:var(--fire3);margin:0.15rem}
.wave-label{font-family:'Cinzel',serif;font-size:1rem;color:rgba(255,200,100,0.7)}

/* ====== ABILITY COOLDOWN ICONS ====== */
#ability-hud{position:fixed;bottom:2.5rem;left:50%;transform:translateX(-50%);display:flex;gap:0.8rem;pointer-events:none;z-index:55}
.ability-icon{width:52px;height:52px;background:rgba(5,2,0,0.8);border:2px solid rgba(255,100,0,0.35);border-radius:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;overflow:hidden;font-family:'Rajdhani',sans-serif}
.ability-icon .ai-emoji{font-size:1.4rem;position:relative;z-index:2}
.ability-icon .ai-key{font-size:0.6rem;color:rgba(255,200,150,0.5);letter-spacing:0.1em;position:relative;z-index:2;margin-top:1px}
.ability-cd-fill{position:absolute;bottom:0;left:0;right:0;background:rgba(255,100,0,0.18);transition:height 0.1s;z-index:1}
.ability-icon.ready{border-color:rgba(255,215,0,0.7);box-shadow:0 0 12px rgba(255,215,0,0.3)}
.ability-icon.active{border-color:#ffd700;box-shadow:0 0 18px rgba(255,215,0,0.5)}
.char-badge{position:fixed;top:1.5rem;left:50%;transform:translateX(-50%);pointer-events:none;z-index:55;font-family:'Cinzel',serif;font-size:0.8rem;color:rgba(255,200,150,0.55);letter-spacing:0.2em;background:rgba(5,2,0,0.6);border:1px solid rgba(255,100,0,0.15);border-radius:20px;padding:0.3rem 1rem}

/* ====== CINEMATIC ALERT ====== */
#alert-box{
  position:fixed;top:38%;left:50%;transform:translateX(-50%) translateY(-8px);
  font-family:'Cinzel',serif;font-size:1.1rem;font-weight:600;
  background:rgba(4,1,0,0.92);
  border-top:1px solid rgba(255,160,40,0.5);border-bottom:1px solid rgba(255,160,40,0.5);
  border-left:1px solid rgba(255,80,0,0.25);border-right:1px solid rgba(255,80,0,0.25);
  border-radius:4px;padding:0.65rem 2.4rem;
  color:#ffd090;letter-spacing:0.18em;text-align:center;
  pointer-events:none;z-index:400;white-space:nowrap;
  opacity:0;transition:opacity 0.3s ease,transform 0.3s ease;
  text-shadow:0 0 16px rgba(255,130,0,0.7);
  box-shadow:0 0 50px rgba(255,80,0,0.2),inset 0 0 30px rgba(255,60,0,0.05);
}
#alert-box.show{opacity:1;transform:translateX(-50%) translateY(0)}
#alert-sub{
  position:fixed;top:calc(38% + 2.6rem);left:50%;transform:translateX(-50%) translateY(-6px);
  font-family:'Rajdhani',sans-serif;font-size:0.8rem;
  color:rgba(255,180,100,0.55);letter-spacing:0.25em;text-align:center;
  pointer-events:none;z-index:400;white-space:nowrap;
  opacity:0;transition:opacity 0.3s ease 0.1s,transform 0.3s ease 0.1s;
}
#alert-sub.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* ====== DAMAGE NUMBERS ====== */
.dmg-num{position:fixed;pointer-events:none;z-index:350;font-family:'Cinzel',serif;font-weight:700;text-shadow:0 0 8px currentColor;animation:dmgFloat 0.9s ease-out forwards}
@keyframes dmgFloat{0%{opacity:1;transform:translateY(0) scale(1)}60%{opacity:1}100%{opacity:0;transform:translateY(-55px) scale(0.7)}}

/* ====== OVERLAYS ====== */
.overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;flex-direction:column;z-index:200;text-align:center;padding:2rem}
#rebirth-overlay{background:radial-gradient(ellipse at center,rgba(255,60,0,0.85) 0%,rgba(0,0,0,0.96) 100%)}
#gameover-overlay{background:rgba(0,0,0,0.9)}
#victory-overlay{background:radial-gradient(ellipse at center,rgba(255,180,0,0.4) 0%,rgba(0,0,0,0.95) 100%)}
#boss-intro{background:rgba(0,0,0,0.92)}
.ov-title{font-family:'Cinzel Decorative',serif;font-size:clamp(2.5rem,6vw,5rem);background:linear-gradient(135deg,#fff,#ffd700,#ff6600,#ff1100);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;filter:drop-shadow(0 0 40px rgba(255,100,0,0.6));animation:fadeZoom 0.6s cubic-bezier(.34,1.56,.64,1)}
@keyframes fadeZoom{from{transform:scale(0.4);opacity:0}to{transform:scale(1);opacity:1}}
.ov-sub{font-family:'Rajdhani',sans-serif;font-size:1.2rem;color:rgba(255,200,150,0.7);margin:1rem 0 0.5rem;max-width:500px}
.ov-stat{font-family:'Cinzel',serif;font-size:1.8rem;color:var(--gold);margin:0.5rem 0}
.g-btn{font-family:'Cinzel',serif;font-weight:700;font-size:1rem;padding:0.9rem 2.5rem;border-radius:50px;border:none;cursor:pointer;margin:0.4rem;letter-spacing:0.1em;transition:all 0.25s}
.g-btn.primary{background:linear-gradient(135deg,#ff2200,#ff7700);color:#fff}
.g-btn.primary:hover{filter:brightness(1.3);transform:scale(1.05)}
.g-btn.ghost{background:transparent;color:var(--fire2);border:1px solid rgba(255,100,0,0.4)}
.g-btn.ghost:hover{background:rgba(255,100,0,0.1)}
.power-unlock-card{background:rgba(255,80,0,0.12);border:1px solid rgba(255,150,0,0.4);border-radius:14px;padding:1.2rem 2rem;margin:1rem 0;max-width:400px}
.puc-title{font-family:'Cinzel',serif;color:var(--gold);font-size:1.1rem;margin-bottom:0.4rem}
.puc-desc{font-family:'Rajdhani',sans-serif;color:rgba(255,220,180,0.7);font-size:0.95rem}
#wave-ann{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);pointer-events:none;z-index:150;text-align:center;opacity:0;transition:opacity 0.4s}
.wan-title{font-family:'Cinzel Decorative',serif;font-size:4rem;background:linear-gradient(135deg,#fff,#ff8800);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.wan-sub{font-family:'Rajdhani',sans-serif;font-size:1.1rem;color:rgba(255,150,80,0.7);letter-spacing:0.3em;margin-top:0.5rem}
.wan-story{font-family:'Rajdhani',sans-serif;font-size:0.9rem;color:rgba(255,180,120,0.45);letter-spacing:0.15em;margin-top:0.4rem;font-style:italic}
#ctrl-hint{position:fixed;bottom:1rem;left:50%;transform:translateX(-50%);font-family:'Rajdhani',sans-serif;font-size:0.75rem;color:rgba(255,120,50,0.35);letter-spacing:0.1em;pointer-events:none;z-index:50;white-space:nowrap}
#flash{position:fixed;inset:0;pointer-events:none;z-index:300;opacity:0;transition:opacity 0.08s}
#boss-hpbar{position:fixed;top:1.5rem;left:50%;transform:translateX(-50%);width:500px;max-width:90vw;pointer-events:none;z-index:50;opacity:0;transition:opacity 0.5s}
.bhp-label{font-family:'Cinzel',serif;font-size:0.9rem;color:var(--fire2);letter-spacing:0.2em;text-align:center;margin-bottom:0.4rem}
.bhp-wrap{height:10px;background:rgba(255,0,0,0.1);border-radius:5px;border:1px solid rgba(255,0,0,0.3);overflow:hidden}
.bhp-fill{height:100%;background:linear-gradient(90deg,#ff0000,#ff5500,#ff9900);transition:width 0.15s;box-shadow:0 0 15px rgba(255,50,0,0.8)}

/* ====== PAUSE OVERLAY ====== */
#pause-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,0.82);backdrop-filter:blur(6px);
  z-index:250;display:none;align-items:center;justify-content:center;flex-direction:column;
}
#pause-overlay.show{display:flex}
.pause-title{font-family:'Cinzel Decorative',serif;font-size:3rem;color:#ffd700;margin-bottom:0.5rem;text-shadow:0 0 30px rgba(255,200,0,0.5)}
.pause-sub{font-family:'Rajdhani',sans-serif;font-size:0.9rem;letter-spacing:0.3em;color:rgba(255,150,80,0.45);margin-bottom:2.5rem}
.pause-menu{display:flex;flex-direction:column;gap:0.8rem;min-width:240px}
.p-btn{font-family:'Cinzel',serif;font-size:1rem;letter-spacing:0.15em;padding:0.9rem 2rem;border-radius:10px;border:1px solid rgba(255,100,0,0.3);background:rgba(10,4,0,0.8);color:#ffcc88;cursor:pointer;transition:all 0.2s;text-align:center}
.p-btn:hover{border-color:var(--fire2);background:rgba(255,80,0,0.12);color:#fff;transform:translateX(6px)}
.p-btn.primary-p{background:rgba(255,60,0,0.2);border-color:rgba(255,100,0,0.6);color:#fff}

/* ====== HELP OVERLAY ====== */
#help-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,0.88);backdrop-filter:blur(8px);
  z-index:260;display:none;align-items:flex-start;justify-content:center;
  overflow-y:auto;padding:2rem 1rem;
}
#help-overlay.show{display:flex}
.help-inner{max-width:860px;width:100%;padding-bottom:2rem}
.help-title{font-family:'Cinzel Decorative',serif;font-size:2rem;color:#ffd700;text-align:center;margin-bottom:0.3rem;text-shadow:0 0 20px rgba(255,200,0,0.5)}
.help-subtitle{font-family:'Rajdhani',sans-serif;font-size:0.85rem;letter-spacing:0.3em;color:rgba(255,150,80,0.45);text-align:center;margin-bottom:2rem}
.help-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
@media(max-width:600px){.help-grid{grid-template-columns:1fr}}
.help-section{background:rgba(10,4,0,0.75);border:1px solid rgba(255,100,0,0.18);border-radius:12px;padding:1.2rem 1.4rem}
.help-section-title{font-family:'Cinzel',serif;font-size:0.9rem;color:var(--fire3);letter-spacing:0.2em;margin-bottom:0.8rem;padding-bottom:0.5rem;border-bottom:1px solid rgba(255,100,0,0.12)}
.help-row{display:flex;align-items:flex-start;gap:0.7rem;margin:0.45rem 0;font-family:'Rajdhani',sans-serif;font-size:0.88rem;color:rgba(255,210,170,0.75);line-height:1.4}
.help-key{display:inline-flex;align-items:center;justify-content:center;min-width:52px;background:rgba(255,100,0,0.12);border:1px solid rgba(255,100,0,0.35);border-radius:5px;padding:0.15rem 0.5rem;font-family:'Cinzel',serif;font-size:0.72rem;color:var(--fire3);white-space:nowrap;flex-shrink:0}
.help-enemy-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;margin-top:4px}
.help-close-row{text-align:center;margin-top:1.5rem}
.help-close-btn{font-family:'Cinzel',serif;font-size:0.95rem;padding:0.7rem 2.5rem;border-radius:50px;border:1px solid rgba(255,100,0,0.4);background:rgba(10,4,0,0.8);color:#ffcc88;cursor:pointer;transition:all 0.2s;letter-spacing:0.12em}
.help-close-btn:hover{border-color:var(--fire2);background:rgba(255,80,0,0.15);color:#fff}

/* ====== SOUND TOGGLE BUTTON ====== */
#sound-btn{
  position:fixed;top:1.5rem;right:1.5rem;z-index:600;
  background:rgba(5,2,0,0.75);border:1px solid rgba(255,100,0,0.25);
  border-radius:8px;padding:0.4rem 0.7rem;font-size:1rem;
  cursor:pointer;color:rgba(255,180,100,0.7);transition:all 0.2s;
  font-family:'Rajdhani',sans-serif;letter-spacing:0.1em;
  display:flex;align-items:center;gap:0.3rem;
}
#sound-btn:hover{border-color:var(--fire2);color:#fff;background:rgba(255,80,0,0.1)}
#sound-btn.muted{color:rgba(255,100,0,0.35);border-color:rgba(255,100,0,0.1)}

/* hover sound: add subtle cursor style to all interactive elements */
button,.cs-card,.ndot,.nbtn,.p-btn{cursor:pointer}

/* ====== MUSIC SELECTOR ====== */
#music-btn{
  position:fixed;top:1.5rem;right:8rem;z-index:600;
  background:rgba(5,2,0,0.75);border:1px solid rgba(255,100,0,0.25);
  border-radius:8px;padding:0.4rem 0.7rem;font-size:1rem;
  cursor:pointer;color:rgba(255,180,100,0.7);transition:all 0.2s;
  font-family:'Rajdhani',sans-serif;letter-spacing:0.1em;
  display:flex;align-items:center;gap:0.3rem;
}
#music-btn:hover{border-color:var(--fire2);color:#fff;background:rgba(255,80,0,0.1)}
#music-panel{
  position:fixed;top:4.2rem;right:8rem;z-index:601;
  background:rgba(5,2,0,0.96);border:1px solid rgba(255,100,0,0.35);
  border-radius:14px;padding:1rem 1.2rem;min-width:220px;
  box-shadow:0 8px 40px rgba(255,80,0,0.25);
  display:none;flex-direction:column;gap:0.5rem;
  backdrop-filter:blur(16px);
}
#music-panel.open{display:flex}
.mp-title{font-family:'Cinzel',serif;font-size:0.75rem;letter-spacing:0.3em;color:rgba(255,150,80,0.5);text-transform:uppercase;margin-bottom:0.4rem;padding-bottom:0.4rem;border-bottom:1px solid rgba(255,100,0,0.15)}
.mp-opt{
  font-family:'Rajdhani',sans-serif;font-size:0.92rem;letter-spacing:0.1em;
  padding:0.5rem 0.8rem;border-radius:8px;cursor:pointer;
  border:1px solid rgba(255,100,0,0.12);background:transparent;
  color:rgba(255,200,150,0.65);transition:all 0.2s;text-align:left;
  display:flex;align-items:center;gap:0.6rem;
}
.mp-opt:hover{border-color:rgba(255,100,0,0.5);background:rgba(255,80,0,0.1);color:#fff}
.mp-opt.active{border-color:#ffd700;background:rgba(255,180,0,0.1);color:#ffd700;box-shadow:0 0 10px rgba(255,200,0,0.2)}
.mp-opt .mp-icon{font-size:1.1rem;width:1.4rem;text-align:center}
.mp-off{color:rgba(255,80,50,0.6)}
.mp-off.active{border-color:rgba(255,50,0,0.6);background:rgba(255,30,0,0.1);color:rgba(255,100,80,0.9);box-shadow:none}
</style>
</head>
<body>
<div id="cursor"><div id="cursor-ring"></div><div id="cursor-dot"></div></div>
<div id="flash"></div>
<div id="alert-box"></div>
<div id="alert-sub"></div>

<!-- ====== SOUND TOGGLE ====== -->
<button id="sound-btn" onclick="SFX.toggleMute()" title="Toggle Sound">üîä <span id="sound-lbl">SFX ON</span></button>

<!-- ====== MUSIC SELECTOR ====== -->
<button id="music-btn" onclick="toggleMusicPanel()" title="Music Style">üéµ <span id="music-lbl">EPIC</span></button>
<div id="music-panel">
  <div class="mp-title">üéµ Music Style</div>
  <button class="mp-opt active" id="mopt-epic"    onclick="setMusicStyle('epic')">    <span class="mp-icon">üî•</span> Epic Battle</button>
  <button class="mp-opt"        id="mopt-ambient" onclick="setMusicStyle('ambient')"> <span class="mp-icon">üåå</span> Ambient Drone</button>
  <button class="mp-opt"        id="mopt-dungeon" onclick="setMusicStyle('dungeon')"> <span class="mp-icon">üèöÔ∏è</span> Dark Dungeon</button>
  <button class="mp-opt"        id="mopt-intense" onclick="setMusicStyle('intense')"> <span class="mp-icon">‚ö°</span> Intense Pulse</button>
  <button class="mp-opt"        id="mopt-mystical"onclick="setMusicStyle('mystical')"><span class="mp-icon">‚ú®</span> Mystical</button>
  <button class="mp-opt mp-off" id="mopt-off"     onclick="setMusicStyle('off')">    <span class="mp-icon">üîá</span> Music OFF</button>
</div>

<!-- ====== HELP OVERLAY ====== -->
<div id="help-overlay">
  <div class="help-inner">
    <div class="help-title">üìñ HOW TO PLAY</div>
    <div class="help-subtitle">PHOENIX FIRE ‚Äî FIELD MANUAL</div>
    <div class="help-grid">

      <!-- Movement & Combat -->
      <div class="help-section">
        <div class="help-section-title">‚öîÔ∏è MOVEMENT &amp; COMBAT</div>
        <div class="help-row"><span class="help-key">W A S D</span>Move your hero in any direction</div>
        <div class="help-row"><span class="help-key">SPACE</span>Fire a Phoenix Fireball ‚Äî costs energy</div>
        <div class="help-row"><span class="help-key">SHIFT</span>Dash ‚Äî rapid teleport-dash, costs energy. Ash Shield power adds invincibility frames</div>
        <div class="help-row"><span class="help-key">E</span>Rebirth Burst ‚Äî triggers when HP &lt; 30. Heals you, blasts nearby enemies, unlocks new power</div>
        <div class="help-row"><span class="help-key">ESC</span>Pause game / open menu</div>
        <div class="help-row"><span class="help-key">H</span>Open / close this help screen</div>
      </div>

      <!-- Objective -->
      <div class="help-section">
        <div class="help-section-title">üéØ OBJECTIVE</div>
        <div class="help-row"><span class="help-key">Goal</span>Survive 5 waves of increasingly powerful enemies and defeat the final Ash Colossus boss</div>
        <div class="help-row"><span class="help-key">Death</span>You have 3 Rebirths. Each death triggers an automatic Rebirth and unlocks a new permanent power</div>
        <div class="help-row"><span class="help-key">World</span>The world gradually saturates with color as you kill enemies ‚Äî a visual sign of progress</div>
        <div class="help-row"><span class="help-key">Score</span>Kill enemies and build combos for multiplied score. Taking damage reduces score slightly</div>
      </div>

      <!-- Combo System -->
      <div class="help-section">
        <div class="help-section-title">üî• COMBO SYSTEM</div>
        <div class="help-row"><span class="help-key">Combo</span>Kill enemies in quick succession to build a combo streak. Score multiplier increases every 5 kills</div>
        <div class="help-row"><span class="help-key">x5</span>IGNITING ‚Äî first milestone</div>
        <div class="help-row"><span class="help-key">x10</span>INFERNO ‚Äî double score multiplier active</div>
        <div class="help-row"><span class="help-key">x15</span>UNSTOPPABLE ‚Äî elite bonus points</div>
        <div class="help-row"><span class="help-key">x20+</span>TRANSCENDENT / UNLEASHED ‚Äî maximum multiplier</div>
        <div class="help-row"><span class="help-key">Tip</span>Combo resets if you stop killing for ~2.5 seconds</div>
      </div>

      <!-- Characters -->
      <div class="help-section">
        <div class="help-section-title">ü¶∏ HERO ABILITIES</div>
        <div class="help-row"><span class="help-key">üî• Phoenix</span>Balanced. On Rebirth: heals to full HP + unlocks an extra power stack faster than other heroes</div>
        <div class="help-row"><span class="help-key">‚ö° Assassin</span>Fastest hero, glass cannon. <strong style="color:#cc88ff">Passive:</strong> Every 5th dash fires 5 homing purple fireballs automatically</div>
        <div class="help-row"><span class="help-key">üåã Titan</span>Slowest, highest HP, heaviest damage. <strong style="color:#ff8800">Passive:</strong> Each dash triggers a shockwave knockback ring on all nearby enemies</div>
      </div>

      <!-- Enemy Types -->
      <div class="help-section">
        <div class="help-section-title">üëæ ENEMY TYPES</div>
        <div class="help-row"><span class="help-enemy-dot" style="background:#dd2200"></span><strong style="color:#ff6644;margin-right:4px">Chaser</strong>Aggressive melee enemy. Charges directly at you</div>
        <div class="help-row"><span class="help-enemy-dot" style="background:#cc44ff"></span><strong style="color:#cc88ff;margin-right:4px">Fast</strong>Low HP but extremely quick. Prioritize these first</div>
        <div class="help-row"><span class="help-enemy-dot" style="background:#996600"></span><strong style="color:#ffaa44;margin-right:4px">Tank</strong>Huge HP, slow. Absorbs many hits ‚Äî use AoE powers</div>
        <div class="help-row"><span class="help-enemy-dot" style="background:#0066dd"></span><strong style="color:#4499ff;margin-right:4px">Strafe</strong>Circles you and fires projectiles. Watch for blue ring</div>
        <div class="help-row"><span class="help-enemy-dot" style="background:#00ccaa"></span><strong style="color:#00ffcc;margin-right:4px">Sniper</strong>Keeps distance, fires precise lead shots. Watch the crosshair indicator</div>
        <div class="help-row"><span class="help-enemy-dot" style="background:#ff6600"></span><strong style="color:#ff9944;margin-right:4px">Berserker</strong>Doubles speed when low HP ‚Äî finish it fast. Orange rage aura signals the trigger</div>
        <div class="help-row"><span class="help-enemy-dot" style="background:#ff4400"></span><strong style="color:#ffd700;margin-right:4px">Elite</strong>Dodges your fireballs actively. Triggers slow-motion on kill. Worth +60 score bonus</div>
      </div>

      <!-- Unlockable Powers -->
      <div class="help-section">
        <div class="help-section-title">‚ú® REBIRTH POWERS (unlock in order)</div>
        <div class="help-row"><span class="help-key">üåä Spread</span>Fireballs split into 3-way spread ‚Äî massive coverage</div>
        <div class="help-row"><span class="help-key">‚ö° Velocity</span>Movement speed +40%</div>
        <div class="help-row"><span class="help-key">üí• Inferno</span>Explosions deal AoE damage in 100px radius on every hit</div>
        <div class="help-row"><span class="help-key">üõ°Ô∏è Shield</span>Dash grants full invincibility frames + leaves a fire trail</div>
        <div class="help-row"><span class="help-key">‚ú® Siphon</span>Kills drop energy/HP orbs ‚Äî pick them up to regenerate</div>
        <div class="help-row"><span class="help-key">üåü Trans.</span>All powers fully amplified ‚Äî you ARE the Phoenix</div>
      </div>

    </div>
    <div class="help-close-row">
      <button class="help-close-btn" onclick="closeHelp()">‚úï &nbsp; CLOSE (H)</button>
    </div>
  </div>
</div>

<!-- ====== PRESENTATION ====== -->
<div id="presentation">
  <div class="slide active" id="s1">
    <canvas id="lava-canvas"></canvas>
    <div id="s1-bg"></div>
    <div class="fire-bar"></div>
    <div class="s1-title">PHOENIX<br>FIRE</div>
    <div class="s1-sub">The Game of Rebirth &amp; Transformation</div>
    <div class="s1-divider"></div>
    <div class="s1-tagline">DEATH IS NOT THE END ‚Äî IT IS EVOLUTION</div>
    <div class="s1-scroll">‚ñº &nbsp; SCROLL TO EXPLORE</div>
    <button onclick="openHelp()" style="position:relative;z-index:3;margin-top:1.5rem;background:rgba(0,0,0,0.5);border:1px solid rgba(255,100,0,0.3);border-radius:30px;padding:0.45rem 1.4rem;font-family:'Rajdhani',sans-serif;font-size:0.8rem;letter-spacing:0.2em;color:rgba(255,180,100,0.6);cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='rgba(255,100,0,0.7)';this.style.color='#fff'" onmouseout="this.style.borderColor='rgba(255,100,0,0.3)';this.style.color='rgba(255,180,100,0.6)'">üìñ HOW TO PLAY</button>
  </div>
  <div class="slide" id="s2">
    <div class="s2-grid">
      <div class="s2-left">
        <span class="slide-tag">Core Concept</span>
        <div class="slide-h1">A World<br>in <span>Eternal Flames</span></div>
        <p class="slide-p">You are <strong style="color:var(--fire3)">The Last Phoenix Fragment</strong> ‚Äî cast into a collapsing world consumed by Ash Entities. Systems decay. Darkness spreads. You alone carry the fire that can reignite what was lost.<br><br>Each death transforms you. Every rebirth makes the world more vibrant. You don't just play the game ‚Äî you <em style="color:var(--fire3)">become</em> it.</p>
      </div>
      <div class="s2-right">
        <div class="concept-card"><div class="cc-icon">üåë</div><div class="cc-title">Act I ‚Äî Awakening in Ruins</div><div class="cc-text">A desaturated world. Muted. Silent. The Ash Entities stir. Your spark flickers to life in the ruins.</div></div>
        <div class="concept-card"><div class="cc-icon">‚ú®</div><div class="cc-title">Act II ‚Äî First Spark of Power</div><div class="cc-text">Ignition. Color bleeds back. New abilities unlock. The Ash Army begins to fear what you're becoming.</div></div>
        <div class="concept-card"><div class="cc-icon">üî•</div><div class="cc-title">Act III ‚Äî Final Rebirth</div><div class="cc-text">The Ash Colossus rises. The world holds its breath. Only the Phoenix can end the darkness forever.</div></div>
      </div>
    </div>
  </div>
  <div class="slide" id="s3">
    <div class="s3-inner">
      <span class="slide-tag">Gameplay</span>
      <div class="slide-h1" style="font-size:clamp(1.8rem,4vw,3rem)">Revolutionary <span style="background:linear-gradient(90deg,var(--fire2),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">Mechanics</span></div>
      <div class="mech-grid">
        <div class="mcard"><div class="mcard-glow"></div><div class="mcard-num">01</div><span class="mcard-icon">üîÑ</span><div class="mcard-title">Rebirth System</div><div class="mcard-desc">Death is progression. Each time you fall, you rise with new powers. The Rebirth mechanic turns failure into evolution.</div></div>
        <div class="mcard"><div class="mcard-glow"></div><div class="mcard-num">02</div><span class="mcard-icon">üåç</span><div class="mcard-title">World Mutation</div><div class="mcard-desc">The environment permanently changes. Enemies evolve. Biomes shift. Your choices leave lasting marks on the world.</div></div>
        <div class="mcard"><div class="mcard-glow"></div><div class="mcard-num">03</div><span class="mcard-icon">‚ö°</span><div class="mcard-title">Phoenix Energy Loop</div><div class="mcard-desc">Burn ‚Üí Destroy ‚Üí Rebuild ‚Üí Upgrade. Energy management and HP create a layered survival loop.</div></div>
        <div class="mcard"><div class="mcard-glow"></div><div class="mcard-num">04</div><span class="mcard-icon">üéØ</span><div class="mcard-title">Elite Enemy AI</div><div class="mcard-desc">Dodgers, chargers, snipers, and berserkers. Each wave escalates intelligence and aggression.</div></div>
      </div>
    </div>
  </div>
  <div class="slide" id="s4">
    <div class="s4-inner">
      <span class="slide-tag">Visual Design</span>
      <div class="slide-h1" style="font-size:clamp(1.8rem,4vw,3rem)">Visual <span style="background:linear-gradient(90deg,var(--fire2),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">Style</span> &amp; Progression</div>
      <div class="color-journey">
        <div class="cj-phase phase-ash"><div class="label">Ashes</div><div class="sublabel">Desolation</div></div>
        <div class="cj-phase phase-ember"><div class="label">Ember</div><div class="sublabel">Awakening</div></div>
        <div class="cj-phase phase-flame"><div class="label">Flame</div><div class="sublabel">Power</div></div>
        <div class="cj-phase phase-gold"><div class="label">Transcendence</div><div class="sublabel">Rebirth</div></div>
      </div>
      <div class="style-cards">
        <div class="scard"><div class="scard-icon">üñºÔ∏è</div><div class="scard-t">Cinematic Trails</div><div class="scard-d">Fireball heat trails, smoke and dynamic glow replace flat projectiles</div></div>
        <div class="scard"><div class="scard-icon">üé®</div><div class="scard-t">Dynamic Color</div><div class="scard-d">World saturates per wave ‚Äî visual storytelling through color</div></div>
        <div class="scard"><div class="scard-icon">üí´</div><div class="scard-t">Hero Aura</div><div class="scard-d">Player radiates wing flares, idle animation and transformation glow</div></div>
        <div class="scard"><div class="scard-icon">ü§ñ</div><div class="scard-t">Elite AI</div><div class="scard-d">Dodgers, snipers, berserkers and tanks with unique behaviors</div></div>
      </div>
    </div>
  </div>
  <div class="slide" id="s5">
    <div class="s5-inner">
      <div>
        <div class="orbit-wrap">
          <div class="orbit-ring1"></div><div class="orbit-ring2"></div>
          <div class="orbit-center"><div class="orbit-logo">OMEGLE</div><div class="orbit-sub">4 ¬∑ members ¬∑ 100%</div></div>
          <div class="member-node mn1">Amarjit</div><div class="member-node mn2">Samyak</div>
          <div class="member-node mn3">Atharva</div><div class="member-node mn4">Piyush</div>
        </div>
      </div>
      <div class="s5-right">
        <span class="slide-tag">Team Omegle</span>
        <div class="slide-h1" style="font-size:2.5rem">Ready to<br><span style="background:linear-gradient(90deg,var(--fire2),var(--gold));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text">Rise?</span></div>
        <p class="slide-p">Choose your hero. Five waves. Three rebirths. One boss. The last fire awaits ignition.</p>
        <div class="stat-row">
          <div class="stat-box"><div class="stat-num">3</div><div class="stat-label">Heroes</div></div>
          <div class="stat-box"><div class="stat-num">5</div><div class="stat-label">Waves</div></div>
          <div class="stat-box"><div class="stat-num">1</div><div class="stat-label">Boss</div></div>
        </div>
        <button class="play-btn" onclick="showCharSelect()">üî• &nbsp; CHOOSE YOUR HERO</button>
      </div>
    </div>
  </div>
</div>

<div id="nav">
  <button class="nbtn prev" onclick="slide(-1)">‚óÄ BACK</button>
  <div class="ndot on" onclick="goTo(0)"></div><div class="ndot" onclick="goTo(1)"></div>
  <div class="ndot" onclick="goTo(2)"></div><div class="ndot" onclick="goTo(3)"></div>
  <div class="ndot" onclick="goTo(4)"></div>
  <button class="nbtn next" onclick="slide(1)">NEXT ‚ñ∂</button>
</div>

<!-- ====== CHARACTER SELECT ====== -->
<div id="char-select">
  <div class="cs-title">CHOOSE YOUR HERO</div>
  <div class="cs-sub">Each hero walks a different path through the flames</div>
  <div class="cs-cards">
    <!-- Phoenix -->
    <div class="cs-card phoenix-card selected" id="card-phoenix" onclick="selectChar('phoenix')">
      <span class="cs-icon">üî•</span>
      <div class="cs-name">The Phoenix</div>
      <div class="cs-role">Balanced Warrior</div>
      <div class="cs-stat"><span class="cs-stat-lbl">HP</span><div class="cs-bar"><div class="cs-bar-fill phoenix-bar" style="width:65%"></div></div></div>
      <div class="cs-stat"><span class="cs-stat-lbl">Speed</span><div class="cs-bar"><div class="cs-bar-fill phoenix-bar" style="width:60%"></div></div></div>
      <div class="cs-stat"><span class="cs-stat-lbl">Damage</span><div class="cs-bar"><div class="cs-bar-fill phoenix-bar" style="width:60%"></div></div></div>
      <div class="cs-passive"><strong>Passive:</strong> Rebirth heals to full HP and unlocks fire powers faster</div>
    </div>
    <!-- Ember Assassin -->
    <div class="cs-card assassin-card" id="card-assassin" onclick="selectChar('assassin')">
      <span class="cs-icon">‚ö°</span>
      <div class="cs-name">Ember Assassin</div>
      <div class="cs-role">Speed ¬∑ Glass Cannon</div>
      <div class="cs-stat"><span class="cs-stat-lbl">HP</span><div class="cs-bar"><div class="cs-bar-fill assassin-bar" style="width:35%"></div></div></div>
      <div class="cs-stat"><span class="cs-stat-lbl">Speed</span><div class="cs-bar"><div class="cs-bar-fill assassin-bar" style="width:95%"></div></div></div>
      <div class="cs-stat"><span class="cs-stat-lbl">Damage</span><div class="cs-bar"><div class="cs-bar-fill assassin-bar" style="width:85%"></div></div></div>
      <div class="cs-passive"><strong>Passive:</strong> Every 5th dash fires a burst of 5 homing embers</div>
    </div>
    <!-- Inferno Titan -->
    <div class="cs-card titan-card" id="card-titan" onclick="selectChar('titan')">
      <span class="cs-icon">üåã</span>
      <div class="cs-name">Inferno Titan</div>
      <div class="cs-role">Tank ¬∑ Devastator</div>
      <div class="cs-stat"><span class="cs-stat-lbl">HP</span><div class="cs-bar"><div class="cs-bar-fill titan-bar" style="width:95%"></div></div></div>
      <div class="cs-stat"><span class="cs-stat-lbl">Speed</span><div class="cs-bar"><div class="cs-bar-fill titan-bar" style="width:28%"></div></div></div>
      <div class="cs-stat"><span class="cs-stat-lbl">Damage</span><div class="cs-bar"><div class="cs-bar-fill titan-bar" style="width:90%"></div></div></div>
      <div class="cs-passive"><strong>Passive:</strong> Melee shockwave on dash ‚Äî knocks back all nearby enemies</div>
    </div>
  </div>
  <button class="cs-play-btn" onclick="startGameWithChar()">üî• IGNITE THE WORLD</button>
  <button class="cs-play-btn" style="margin-top:0.6rem;background:transparent;border:1px solid rgba(255,100,0,0.35);color:rgba(255,180,100,0.7);font-size:0.9rem;padding:0.6rem 2rem;" onclick="openHelp()">üìñ HOW TO PLAY</button>
</div>

<!-- ====== GAME ====== -->
<div id="game">
  <canvas id="gc"></canvas>
  <div id="hud">
    <div class="hud-tl">
      <div class="hud-panel">
        <div class="hud-lbl">Phoenix Energy</div>
        <div class="ebar-wrap"><div class="ebar" id="ebar" style="width:100%"></div><div class="ebar-glow" id="ebar-glow" style="right:0%"></div></div>
        <div class="hud-lbl" style="margin-top:0.5rem">Health</div>
        <div class="hpbar-wrap"><div class="hpbar" id="hpbar" style="width:100%"></div></div>
      </div>
      <div class="hud-panel" id="powers-panel" style="display:none">
        <div class="hud-lbl">Powers</div>
        <div id="powers-list"></div>
      </div>
    </div>
    <div class="hud-tr">
      <div class="hud-panel" style="margin-bottom:0.8rem"><div class="hud-lbl">Score</div><div class="hud-val" id="score-val">0</div></div>
      <div class="hud-panel" style="margin-bottom:0.8rem"><div class="hud-lbl">Rebirths</div><div class="hud-val" id="rebirth-val">0</div></div>
      <div class="hud-panel"><div class="hud-lbl wave-label" id="wave-lbl">Wave 1</div><div class="hud-val" id="kills-val" style="font-size:1rem;color:rgba(255,200,150,0.6)"></div></div>
    </div>
    <div class="hud-bc"><div class="combo-display" id="combo-disp"></div></div>
  </div>
  <!-- Ability cooldown icons -->
  <div id="ability-hud">
    <div class="ability-icon" id="ab-shoot"><span class="ai-emoji">üî•</span><span class="ai-key">SPACE</span><div class="ability-cd-fill" id="ab-shoot-cd" style="height:0%"></div></div>
    <div class="ability-icon" id="ab-dash"><span class="ai-emoji">üí®</span><span class="ai-key">SHIFT</span><div class="ability-cd-fill" id="ab-dash-cd" style="height:0%"></div></div>
    <div class="ability-icon" id="ab-rebirth"><span class="ai-emoji">‚ôªÔ∏è</span><span class="ai-key">E</span><div class="ability-cd-fill" id="ab-rebirth-cd" style="height:0%"></div></div>
  </div>
  <div class="char-badge" id="char-badge">Phoenix</div>
  <div id="boss-hpbar">
    <div class="bhp-label" id="boss-name">‚ö† ASH COLOSSUS ‚ö†</div>
    <div class="bhp-wrap"><div class="bhp-fill" id="boss-fill" style="width:100%"></div></div>
  </div>
  <div id="wave-ann">
    <div class="wan-title" id="wan-title"></div>
    <div class="wan-sub" id="wan-sub"></div>
    <div class="wan-story" id="wan-story"></div>
  </div>
  <div id="ctrl-hint">WASD ‚Äî Move &nbsp;¬∑&nbsp; SPACE ‚Äî Shoot &nbsp;¬∑&nbsp; SHIFT ‚Äî Dash &nbsp;¬∑&nbsp; E ‚Äî Rebirth Burst &nbsp;¬∑&nbsp; ESC ‚Äî Pause</div>
</div>

<!-- ====== PAUSE OVERLAY ====== -->
<div id="pause-overlay">
  <div class="pause-title">‚è∏ PAUSED</div>
  <div class="pause-sub">THE FLAMES WAIT FOR YOUR RETURN</div>
  <div class="pause-menu">
    <button class="p-btn primary-p" onclick="resumeGame()">‚ñ∂ RESUME</button>
    <button class="p-btn" onclick="openHelp()">üìñ HOW TO PLAY</button>
    <button class="p-btn" onclick="restartGame()">‚Ü∫ RESTART</button>
    <button class="p-btn" onclick="backToSlides()">‚óÄ QUIT TO MENU</button>
  </div>
</div>

<!-- ====== OVERLAYS ====== -->
<div class="overlay" id="rebirth-overlay">
  <div class="ov-title">REBIRTH!</div>
  <div class="ov-sub">You rise from the ashes, stronger than before</div>
  <div class="power-unlock-card">
    <div class="puc-title" id="puc-title">New Power Unlocked</div>
    <div class="puc-desc" id="puc-desc"></div>
  </div>
  <div class="ov-sub" id="rebirth-count-msg" style="font-size:1rem;opacity:0.5"></div>
</div>
<div class="overlay" id="gameover-overlay">
  <div class="ov-title" style="font-size:3rem;color:var(--fire1)">EXTINGUISHED</div>
  <div class="ov-sub">The Phoenix Fire fades... but was it worth it?</div>
  <div class="ov-stat" id="go-score"></div>
  <div class="ov-stat" id="go-wave" style="font-size:1.2rem;color:rgba(255,200,150,0.6)"></div>
  <div style="margin-top:1rem">
    <button class="g-btn primary" onclick="showCharSelect()">üî• Choose Hero &amp; Rise Again</button>
    <button class="g-btn ghost" onclick="backToSlides()">‚óÄ Presentation</button>
  </div>
</div>
<div class="overlay" id="victory-overlay">
  <div class="ov-title">WORLD REBORN</div>
  <div class="ov-sub">You have reignited the Phoenix Fire and restored balance to the collapsed world</div>
  <div class="ov-stat" id="vic-score"></div>
  <div class="ov-stat" id="vic-combo" style="font-size:1.1rem;color:rgba(255,200,150,0.6)"></div>
  <div style="margin-top:1rem">
    <button class="g-btn primary" onclick="showCharSelect()">üî• Play Again</button>
    <button class="g-btn ghost" onclick="backToSlides()">‚óÄ Presentation</button>
  </div>
</div>
<div class="overlay" id="boss-intro">
  <div class="ov-title" style="font-size:2.5rem;color:var(--fire1)">‚ö† BOSS INCOMING ‚ö†</div>
  <div class="ov-sub">The Ash Colossus rises ‚Äî the embodiment of all that opposes rebirth</div>
  <div class="ov-sub" style="font-size:1rem;opacity:0.5;margin-top:0.5rem">Wave 5 ‚Äî Final Stand</div>
</div>

<script>
// =====================================================
// CURSOR
// =====================================================
const cursorRing=document.getElementById('cursor-ring');
const cursorDot=document.getElementById('cursor-dot');
let mx=window.innerWidth/2,my=window.innerHeight/2,rx=mx,ry=my;
document.addEventListener('mousemove',e=>{mx=e.clientX;my=e.clientY;cursorDot.style.left=mx+'px';cursorDot.style.top=my+'px';});
(function animCursor(){rx+=(mx-rx)*0.15;ry+=(my-ry)*0.15;cursorRing.style.left=rx+'px';cursorRing.style.top=ry+'px';requestAnimationFrame(animCursor);})();

// =====================================================
// LAVA BACKGROUND (slide 1)
// =====================================================
const lc=document.getElementById('lava-canvas');
const lx=lc.getContext('2d');
let lt=0;
function resizeLava(){lc.width=window.innerWidth;lc.height=window.innerHeight;}
resizeLava();window.addEventListener('resize',resizeLava);
function drawLava(){
  lx.clearRect(0,0,lc.width,lc.height);
  for(let i=0;i<8;i++){const x=lc.width*(0.1+i*0.12)+Math.sin(lt*0.4+i)*80;const y=lc.height*0.85+Math.cos(lt*0.3+i*1.2)*30;const r=80+Math.sin(lt*0.5+i)*40;const g=lx.createRadialGradient(x,y,0,x,y,r);g.addColorStop(0,`rgba(255,${60+i*10},0,0.3)`);g.addColorStop(1,'transparent');lx.fillStyle=g;lx.beginPath();lx.arc(x,y,r,0,Math.PI*2);lx.fill();}
  for(let i=0;i<30;i++){const ex=(Math.sin(lt*0.2+i*2.3)*0.5+0.5)*lc.width;const ey=lc.height-(((lt*0.3+i*13.7)%100)/100)*lc.height*0.6;const er=1+Math.sin(lt+i)*0.5;lx.beginPath();lx.arc(ex,ey,er,0,Math.PI*2);lx.fillStyle=`rgba(255,${100+i*5},0,${0.4+Math.sin(lt+i)*0.3})`;lx.fill();}
  lt+=0.016;requestAnimationFrame(drawLava);
}
drawLava();

// =====================================================
// SLIDES
// =====================================================
let curSlide=0;
const slides=document.querySelectorAll('.slide');
const dots=document.querySelectorAll('.ndot');
function goTo(n){slides[curSlide].classList.remove('active');dots[curSlide].classList.remove('on');curSlide=Math.max(0,Math.min(slides.length-1,n));slides[curSlide].classList.add('active');dots[curSlide].classList.add('on');}
function slide(d){goTo(curSlide+d);}
document.addEventListener('keydown',e=>{
  // Pause toggle
  if(e.key==='Escape'&&document.getElementById('game').style.display==='block'){
    // if help is open, close it instead
    if(document.getElementById('help-overlay').classList.contains('show')){closeHelp();return;}
    togglePause();return;
  }
  // Help key ‚Äî works everywhere except when typing
  if(e.key==='h'||e.key==='H'){
    if(document.getElementById('help-overlay').classList.contains('show')){closeHelp();}
    else{openHelp();}
    return;
  }
  if(document.getElementById('game').style.display==='block')return;
  if(document.getElementById('char-select').style.display==='flex')return;
  if(e.key==='ArrowRight'||e.key==='ArrowDown')slide(1);
  if(e.key==='ArrowLeft'||e.key==='ArrowUp')slide(-1);
});

// =====================================================
// CHARACTER SELECT
// =====================================================
let selectedChar='phoenix';
function selectChar(id){
  selectedChar=id;
  document.querySelectorAll('.cs-card').forEach(c=>c.classList.remove('selected'));
  document.getElementById('card-'+id).classList.add('selected');
}
function showCharSelect(){
  // hide everything else
  document.getElementById('presentation').style.display='none';
  document.getElementById('nav').style.display='none';
  document.getElementById('game').style.display='none';
  ['rebirth-overlay','gameover-overlay','victory-overlay','boss-intro'].forEach(id=>document.getElementById(id).style.display='none');
  const cs=document.getElementById('char-select');
  cs.style.display='flex';
}
function startGameWithChar(){
  document.getElementById('char-select').style.display='none';
  document.getElementById('game').style.display='block';
  ['rebirth-overlay','gameover-overlay','victory-overlay','boss-intro'].forEach(id=>document.getElementById(id).style.display='none');
  document.getElementById('boss-hpbar').style.opacity=0;
  initGame();
}
// legacy entry from last slide button
function startGame(){showCharSelect();}

// =====================================================
// CHARACTER DEFINITIONS
// =====================================================
const CHAR_DEFS={
  phoenix:{
    name:'The Phoenix',emoji:'üî•',
    hp:100,speed:5.5,dmgMult:1.0,dashCost:8,shootCost:4,
    auraColor:'rgba(255,180,50,',auraColor2:'rgba(255,100,0,',
    passiveName:'Eternal Flame',
    passiveDesc:'Rebirth heals to full and grants extra power stacks',
  },
  assassin:{
    name:'Ember Assassin',emoji:'‚ö°',
    hp:55,speed:8.5,dmgMult:1.6,dashCost:5,shootCost:3,
    auraColor:'rgba(200,80,255,',auraColor2:'rgba(140,0,255,',
    passiveName:'Homing Burst',
    passiveDesc:'Every 5th dash fires a burst of homing embers',
  },
  titan:{
    name:'Inferno Titan',emoji:'üåã',
    hp:220,speed:2.8,dmgMult:2.1,dashCost:12,shootCost:6,
    auraColor:'rgba(255,40,0,',auraColor2:'rgba(200,0,0,',
    passiveName:'Shockwave Dash',
    passiveDesc:'Dash knocks back all nearby enemies',
  },
};

// =====================================================
// ALERT SYSTEM
// =====================================================
let alertTimer=null;
function showAlert(main,sub='',duration=2200){
  const el=document.getElementById('alert-box');const sl=document.getElementById('alert-sub');
  if(alertTimer) clearTimeout(alertTimer);
  el.textContent=main;sl.textContent=sub;
  el.classList.add('show');sl.classList.add('show');
  alertTimer=setTimeout(()=>{el.classList.remove('show');sl.classList.remove('show');},duration);
}

// =====================================================
// POWERS
// =====================================================
const POWERS=[
  {name:'Spread Fire',icon:'üåä',desc:'Each fireball splits into 3 ‚Äî massive area coverage'},
  {name:'Phoenix Velocity',icon:'‚ö°',desc:'Movement speed +40% ‚Äî become the wind'},
  {name:'Inferno Core',icon:'üí•',desc:'Explosions deal AoE damage in 100px radius'},
  {name:'Ash Shield',icon:'üõ°Ô∏è',desc:'Dash grants invincibility and leaves fire trail'},
  {name:'Soul Siphon',icon:'‚ú®',desc:'Kills drop orbs that heal HP'},
  {name:'Transcendence',icon:'üåü',desc:'All powers amplified ‚Äî you ARE the Phoenix'},
];

// =====================================================
// NARRATIVE
// =====================================================
const WAVE_LORE=[
  {title:'WAVE I',sub:'Awakening in Ruins',story:'"The world remembers nothing. Begin again."'},
  {title:'WAVE II',sub:'First Spark of Power',story:'"They sense your fire. They will not let you burn."'},
  {title:'WAVE III',sub:'Reality Mutates',story:'"The Phoenix energy is rewriting the rules."'},
  {title:'WAVE IV',sub:'Ash Army Fights Back',story:'"They have called every shadow. Hold the flame."'},
  {title:'WAVE V',sub:'The Final Colossus',story:'"This is what consumed the world. End it."'},
];
const COMBO_LORE={5:'IGNITING!',10:'INFERNO!',15:'UNSTOPPABLE!',20:'TRANSCENDENT!',30:'PHOENIX UNLEASHED!'};

// =====================================================
// GAME STATE
// =====================================================
const canvas=document.getElementById('gc');
const ctx=canvas.getContext('2d');
let G=null,raf=null,running=false,paused=false;

function initGame(){
  canvas.width=window.innerWidth;canvas.height=window.innerHeight;
  running=true;paused=false;
  const cd=CHAR_DEFS[selectedChar];
  document.getElementById('char-badge').textContent=cd.emoji+' '+cd.name;
  G={
    char:selectedChar,
    p:{
      x:canvas.width/2,y:canvas.height-120,w:40,h:40,
      vx:0,vy:0,
      energy:100,maxE:100,hp:cd.hp,maxHp:cd.hp,
      speed:cd.speed,alive:true,invincible:0,dashCD:0,
      score:0,rebirths:0,combo:0,comboTimer:0,maxCombo:0,
      powers:[],trail:[],shootCD:0,rebirthCD:0,
      dashDir:{x:0,y:0},dashing:false,dashFrame:0,
      auraPhase:0,idlePhase:0,rebirthGlow:0,
      dashCount:0,// for assassin passive
    },
    fireballs:[],enemies:[],particles:[],orbs:[],embers:[],
    bgStars:[],
    boss:null,bossActive:false,
    wave:0,waveEnemiesTotal:0,waveSpawned:0,waveKilled:0,spawnTimer:0,
    worldColor:0,shakeX:0,shakeY:0,shakeAmt:0,
    slowMo:1,slowMoTimer:0,
    tick:0,transitioning:false,lastWaveComplete:false,
    lowHpAlerted:false,
    bossArenaGlow:0,
    knockbackRings:[],// melee knockback ring FX
  };
  for(let i=0;i<120;i++) G.bgStars.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,r:Math.random()*1.5+0.2,t:Math.random()*Math.PI*2,spd:0.005+Math.random()*0.01});
  for(let i=0;i<60;i++) G.embers.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,vx:(Math.random()-.5)*0.6,vy:-(0.3+Math.random()*0.8),r:Math.random()*2.5+0.5,life:Math.random()*200,maxLife:200+Math.random()*200,flicker:Math.random()*Math.PI*2});
  startWave(1);
  if(raf) cancelAnimationFrame(raf);
  SFX.startMusic();
  loop();
}

// =====================================================
// PAUSE
// =====================================================
function togglePause(){
  if(!running) return;
  paused=!paused;
  const po=document.getElementById('pause-overlay');
  if(paused){
    po.classList.add('show');
    SFX.play('ui');
    SFX.pauseMusic();
  } else {
    po.classList.remove('show');
    SFX.resumeMusic();
  }
}
function resumeGame(){
  paused=false;
  document.getElementById('pause-overlay').classList.remove('show');
  SFX.resumeMusic();
}

// =====================================================
// WAVE & NARRATIVE
// =====================================================
function startWave(n){
  G.wave=n;const isBoss=n===5;
  G.waveEnemiesTotal=isBoss?1:(5+n*4);
  G.waveSpawned=0;G.waveKilled=0;G.spawnTimer=0;
  G.bossActive=isBoss;G.boss=null;G.lowHpAlerted=false;
  const lore=WAVE_LORE[n-1];
  if(isBoss){
    document.getElementById('boss-intro').style.display='flex';
    setTimeout(()=>{
      document.getElementById('boss-intro').style.display='none';
      spawnBoss();document.getElementById('boss-hpbar').style.opacity=1;
      annWave(lore.title,lore.sub,lore.story);
      showAlert('‚ö† ASH COLOSSUS RISES','The final darkness awakens',3000);
      G.bossArenaGlow=1;
    },2500);
  } else {
    annWave(lore.title,lore.sub,lore.story);
    setTimeout(()=>showAlert(lore.title,lore.story,2500),400);
  }
  document.getElementById('wave-lbl').textContent='Wave '+n;
}
function annWave(title,sub,story=''){
  const el=document.getElementById('wave-ann');
  document.getElementById('wan-title').textContent=title;
  document.getElementById('wan-sub').textContent=sub;
  document.getElementById('wan-story').textContent=story;
  el.style.opacity=1;setTimeout(()=>el.style.opacity=0,3000);
}
function shake(amt){G.shakeAmt=Math.max(G.shakeAmt,amt);}
function flash(color,dur=120){const f=document.getElementById('flash');f.style.background=color;f.style.opacity=0.45;setTimeout(()=>{f.style.opacity=0;},dur);}
function spawnDmgNum(x,y,val,isElite=false){
  const el=document.createElement('div');el.className='dmg-num';
  el.textContent=Math.floor(val);
  const sz=isElite?22:Math.min(22,12+Math.floor(val/15));
  el.style.cssText=`left:${x-20}px;top:${y-10}px;font-size:${sz}px;color:${isElite?'#ffd700':val>50?'#ff6600':'#ffaa44'};`;
  document.body.appendChild(el);setTimeout(()=>el.remove(),900);
}
function triggerSlowMo(frames=40){G.slowMo=0.25;G.slowMoTimer=frames;}

// =====================================================
// INPUT
// =====================================================
const keys={};
document.addEventListener('keydown',e=>{keys[e.code]=true;if(['Space','ShiftLeft','ShiftRight','KeyE'].includes(e.code))e.preventDefault();});
document.addEventListener('keyup',e=>keys[e.code]=false);

// =====================================================
// PLAYER ACTIONS
// =====================================================
function tryShoot(){
  const p=G.p;if(p.shootCD>0||p.energy<CHAR_DEFS[G.char].shootCost)return;
  const hasSplit=p.powers.includes(0);
  const baseDmg=(30+p.powers.length*8)*CHAR_DEFS[G.char].dmgMult;
  const base={vx:0,vy:-11,r:9,dmg:baseDmg,trail:[],enemy:false};
  G.fireballs.push({...base,x:p.x,y:p.y-p.h/2});
  if(hasSplit){G.fireballs.push({...base,x:p.x,y:p.y-p.h/2,vx:-3.5,vy:-9.5});G.fireballs.push({...base,x:p.x,y:p.y-p.h/2,vx:3.5,vy:-9.5});}
  spawnParticles(p.x,p.y-p.h/2,5,'#ff8800',2,3);
  p.shootCD=12;p.energy-=CHAR_DEFS[G.char].shootCost;
  SFX.play('shoot');
}

function tryDash(){
  const p=G.p;const cd=CHAR_DEFS[G.char];
  if(p.dashCD>0||p.energy<cd.dashCost)return;
  let dx=keys['KeyA']||keys['ArrowLeft']?-1:keys['KeyD']||keys['ArrowRight']?1:0;
  let dy=keys['KeyW']||keys['ArrowUp']?-1:keys['KeyS']||keys['ArrowDown']?1:-1;
  const len=Math.sqrt(dx*dx+dy*dy)||1;dx/=len;dy/=len;
  p.dashDir={x:dx,y:dy};p.dashing=true;p.dashFrame=0;
  for(let i=0;i<18;i++) G.particles.push({x:p.x+dx*i*8,y:p.y+dy*i*8,vx:dx*-3+(Math.random()-.5)*4,vy:dy*-3+(Math.random()-.5)*4,life:25,maxLife:25,r:6+Math.random()*5,color:`hsl(${25+Math.random()*25},100%,60%)`});
  p.x+=dx*140;p.y+=dy*140;
  p.x=Math.max(p.w/2,Math.min(canvas.width-p.w/2,p.x));
  p.y=Math.max(p.h/2,Math.min(canvas.height-p.h/2,p.y));
  if(p.powers.includes(3))p.invincible=45;
  p.dashCD=50;p.energy-=cd.dashCost;shake(6);
  flash('rgba(255,100,0,0.15)',80);
  SFX.play('dash');
  p.dashCount=(p.dashCount||0)+1;
  // --- PASSIVE: Titan shockwave ---
  if(G.char==='titan'){
    const rng=240;
    G.enemies.forEach(en=>{const edx=en.x-p.x,edy=en.y-p.y;const d=Math.sqrt(edx*edx+edy*edy);if(d<rng){const nf=d>0?1/d:1;en.vxKnock=(edx*nf)*22;en.vyKnock=(edy*nf)*22;en.knockTimer=20;spawnParticles(en.x,en.y,8,en.color,3,6);}});
    G.knockbackRings.push({x:p.x,y:p.y,r:0,maxR:rng,life:22,maxLife:22});
    flash('rgba(255,50,0,0.3)',120);shake(10);
  }
  // --- PASSIVE: Assassin homing burst every 5 dashes ---
  if(G.char==='assassin'&&p.dashCount%5===0){
    for(let i=0;i<5;i++){
      const a=Math.PI*2/5*i;
      G.fireballs.push({x:p.x,y:p.y,vx:Math.cos(a)*5,vy:Math.sin(a)*5,r:7,dmg:45,trail:[],enemy:false,homing:true,homeTimer:40+i*5});
    }
    showAlert('‚ö° HOMING BURST','Assassin passive activated',1600);
    flash('rgba(160,0,255,0.3)',100);
  }
}

function tryRebirthBurst(){
  const p=G.p;if(p.rebirthCD>0)return;
  if(p.hp>35&&p.rebirths<3)return;
  doRebirth(false);
}

function doRebirth(fromDeath){
  if(G.transitioning)return;
  G.transitioning=true;
  const p=G.p;p.rebirths++;
  // Phoenix heals to full, others partial
  p.energy=p.maxE;
  p.hp=G.char==='phoenix'?p.maxHp:Math.min(p.maxHp,p.hp+p.maxHp*0.6);
  p.rebirthCD=360;p.rebirthGlow=120;G.worldColor=Math.min(1,G.worldColor+0.2);G.lowHpAlerted=false;
  // Phoenix gets extra power stack
  const pwrIdx=(p.rebirths-1)%POWERS.length;
  if(!p.powers.includes(pwrIdx))p.powers.push(pwrIdx);
  if(G.char==='phoenix'&&p.rebirths>1){const extra=(p.rebirths)%POWERS.length;if(!p.powers.includes(extra))p.powers.push(extra);}
  const pwr=POWERS[pwrIdx];
  for(let i=0;i<100;i++){const a=Math.PI*2/100*i,spd=6+Math.random()*10;G.particles.push({x:p.x,y:p.y,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd,life:90,maxLife:90,r:5+Math.random()*6,color:`hsl(${15+Math.random()*50},100%,${55+Math.random()*30}%)`});}
  G.enemies.forEach(en=>{const dx=en.x-p.x,dy=en.y-p.y;if(Math.sqrt(dx*dx+dy*dy)<280){en.hp-=220;spawnParticles(en.x,en.y,14,en.color,3,6);}});
  if(G.boss){const dx=G.boss.x-p.x,dy=G.boss.y-p.y;if(Math.sqrt(dx*dx+dy*dy)<320)G.boss.hp-=120;}
  if(fromDeath){p.x=canvas.width/2;p.y=canvas.height-120;p.alive=true;p.invincible=200;}
  shake(15);flash('rgba(255,150,0,1)',200);
  SFX.play('rebirth');
  showAlert('üî• REBIRTH',`Power Unlocked: ${pwr.icon} ${pwr.name}`,3200);
  document.getElementById('puc-title').textContent=pwr.icon+' '+pwr.name;
  document.getElementById('puc-desc').textContent=pwr.desc;
  document.getElementById('rebirth-count-msg').textContent=`Rebirth ${p.rebirths} of 3`;
  showOverlay('rebirth-overlay');updatePowersHUD();
  setTimeout(()=>{hideOverlay('rebirth-overlay');G.transitioning=false;},2800);
}

function showOverlay(id){document.getElementById(id).style.display='flex';}
function hideOverlay(id){document.getElementById(id).style.display='none';}
function spawnParticles(x,y,count,color,minR=2,maxR=5){for(let i=0;i<count;i++) G.particles.push({x,y,vx:(Math.random()-.5)*7,vy:(Math.random()-.5)*7-2,life:38,maxLife:38,r:minR+Math.random()*(maxR-minR),color});}

// =====================================================
// ENEMY SPAWN ‚Äî 7 ARCHETYPES
// =====================================================
function spawnEnemy(){
  const wv=G.wave,r=Math.random();
  let type;
  if(wv>=4&&r<0.10) type='elite';
  else if(wv>=3&&r<0.18) type='berserker';
  else if(wv>=2&&r<0.28) type='sniper';
  else if(r<0.36) type='tank';
  else if(r<0.54) type='fast';
  else if(r<0.72) type='strafe';
  else type='normal';

  const side=Math.floor(Math.random()*4);
  let x,y;
  if(side===0){x=Math.random()*canvas.width;y=-50;}
  else if(side===1){x=canvas.width+50;y=Math.random()*canvas.height*0.75;}
  else if(side===2){x=-50;y=Math.random()*canvas.height*0.75;}
  else{x=Math.random()*canvas.width;y=-50;}

  const cfgs={
    normal:{hp:55+wv*12,maxHp:55+wv*12,speed:1.5+wv*0.18,r:18,color:'#dd2200',score:10,dmg:0.55,behavior:'chase'},
    fast:{hp:28+wv*6,maxHp:28+wv*6,speed:3.2+wv*0.25,r:13,color:'#cc44ff',score:18,dmg:0.4,behavior:'chase'},
    tank:{hp:200+wv*35,maxHp:200+wv*35,speed:0.65,r:34,color:'#996600',score:40,dmg:1.2,behavior:'chase'},
    strafe:{hp:45+wv*9,maxHp:45+wv*9,speed:1.8+wv*0.15,r:16,color:'#0066dd',score:28,dmg:0,behavior:'strafe',shootCD:55,strafeDir:Math.random()<0.5?1:-1,strafeTimer:0},
    elite:{hp:90+wv*18,maxHp:90+wv*18,speed:2.2+wv*0.2,r:20,color:'#ff4400',score:60,dmg:0.7,behavior:'dodge',dodgeCd:0,isElite:true},
    sniper:{hp:38+wv*8,maxHp:38+wv*8,speed:1.0+wv*0.1,r:15,color:'#00ccaa',score:35,dmg:0,behavior:'sniper',shootCD:90,preferDist:350,isSniperType:true},
    berserker:{hp:60+wv*14,maxHp:60+wv*14,speed:1.4+wv*0.16,r:19,color:'#ff6600',score:50,dmg:0.65,behavior:'berserker',baseSpeed:1.4+wv*0.16,isBerserker:true},
  };
  const cfg={...cfgs[type],x,y,type,pulse:Math.random()*Math.PI*2,shootCD:(cfgs[type].shootCD||80)+Math.random()*40,attackAnim:0,vxKnock:0,vyKnock:0,knockTimer:0};
  G.enemies.push(cfg);
}

function spawnBoss(){
  G.boss={x:canvas.width/2,y:180,w:82,h:82,hp:700,maxHp:700,phase:1,vx:1.8,vy:0.3,shootCD:0,chargeCD:120,chargeTarget:null,charging:false,pulse:0,tentacles:[],spikeAnim:0,dmgFlash:0};
  for(let i=0;i<8;i++) G.boss.tentacles.push({angle:i/8*Math.PI*2,len:75,t:Math.random()*Math.PI*2});
  document.getElementById('boss-fill').style.width='100%';
  SFX.play('bossDanger');
}

// =====================================================
// MAIN LOOP
// =====================================================
function loop(){
  raf=requestAnimationFrame(loop);
  if(!running) return;
  if(paused) return;
  if(G.slowMoTimer>0){G.slowMoTimer--;if(G.slowMoTimer<=0)G.slowMo=1;}
  update();render();
}

// =====================================================
// UPDATE
// =====================================================
function update(){
  if(G.transitioning)return;
  const sm=G.slowMo;
  G.tick++;
  const p=G.p;const cd=CHAR_DEFS[G.char];

  G.shakeAmt*=0.82;G.shakeX=(Math.random()-.5)*G.shakeAmt*2;G.shakeY=(Math.random()-.5)*G.shakeAmt*2;

  // SMOOTH MOVEMENT
  const targetVx=(keys['KeyA']||keys['ArrowLeft']?-1:keys['KeyD']||keys['ArrowRight']?1:0);
  const targetVy=(keys['KeyW']||keys['ArrowUp']?-1:keys['KeyS']||keys['ArrowDown']?1:0);
  const spd=p.speed*(p.powers.includes(1)?1.42:1);
  const accel=0.28,decel=0.22;
  p.vx+=(targetVx*spd-p.vx)*(targetVx!==0?accel:decel);
  p.vy+=(targetVy*spd-p.vy)*(targetVy!==0?accel:decel);
  const mv=Math.sqrt(p.vx*p.vx+p.vy*p.vy);if(mv>spd){p.vx=p.vx/mv*spd;p.vy=p.vy/mv*spd;}
  p.x=Math.max(p.w/2,Math.min(canvas.width-p.w/2,p.x+p.vx*sm));
  p.y=Math.max(p.h/2,Math.min(canvas.height-p.h/2,p.y+p.vy*sm));

  p.trail.unshift({x:p.x,y:p.y});if(p.trail.length>24)p.trail.pop();
  p.auraPhase+=0.04;p.idlePhase+=0.03;
  if(p.rebirthGlow>0)p.rebirthGlow--;
  if(p.dashFrame<20)p.dashFrame++;

  if(p.powers.includes(3)&&p.invincible>0&&mv>0.5)spawnParticles(p.x,p.y+p.h/2,2,'#ffaa00');
  if(p.powers.includes(4)&&mv>0.5&&G.tick%3===0)spawnParticles(p.x,p.y+p.h/2,3,'#ff4400',3,6);

  if(p.dashCD>0)p.dashCD--;if(p.invincible>0)p.invincible--;
  if(p.shootCD>0)p.shootCD--;if(p.rebirthCD>0)p.rebirthCD--;
  if(p.comboTimer>0){p.comboTimer--;}else if(p.combo>0){p.combo=0;updateComboHUD();}

  if(keys['Space'])tryShoot();
  if(keys['ShiftLeft']||keys['ShiftRight'])tryDash();
  if(keys['KeyE']&&p.rebirthCD<=0&&p.hp<30)tryRebirthBurst();

  // melee knockback ring (auto, close range)
  if(G.tick%18===0){
    let nearCount=0;
    G.enemies.forEach(en=>{const dx=en.x-p.x,dy=en.y-p.y;const d=Math.sqrt(dx*dx+dy*dy);if(d<95){nearCount++;const nf=1/d;en.vxKnock=(dx*nf)*30;en.vyKnock=(dy*nf)*30;en.knockTimer=15;en.hp-=15;spawnParticles(en.x,en.y,5,'#ffaa00');}});
    if(nearCount>0){G.knockbackRings.push({x:p.x,y:p.y,r:10,maxR:95,life:14,maxLife:14});shake(4);}
  }

  p.energy=Math.min(p.maxE,p.energy+0.045);
  if(p.hp<30&&p.alive&&!G.lowHpAlerted){G.lowHpAlerted=true;showAlert('‚ö† CRITICAL HP','Phoenix fire is fading...',2500);SFX.play('lowHp');}

  if(p.hp<=0&&p.alive){
    p.hp=0;p.alive=false;
    if(p.rebirths<3){doRebirth(true);}
    else{
      for(let i=0;i<130;i++){const a=Math.PI*2/130*i,sp=4+Math.random()*12;G.particles.push({x:p.x,y:p.y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:100,maxLife:100,r:4+Math.random()*8,color:`hsl(${Math.random()*45},100%,${40+Math.random()*45}%)`});}
      shake(22);flash('rgba(180,0,0,1)',300);setTimeout(showGameOver,700);
    }
  }

  // KNOCKBACK RINGS DECAY
  G.knockbackRings=G.knockbackRings.filter(r=>{r.r+=r.maxR/r.maxLife*2.5;r.life--;return r.life>0;});

  // FIREBALLS
  G.fireballs=G.fireballs.filter(fb=>{
    fb.x+=fb.vx*sm;fb.y+=fb.vy*sm;
    // homing logic (assassin passive)
    if(fb.homing&&fb.homeTimer>0){
      fb.homeTimer--;
      let closest=null,cDist=Infinity;
      G.enemies.forEach(en=>{const dx=en.x-fb.x,dy=en.y-fb.y,d=Math.sqrt(dx*dx+dy*dy);if(d<cDist){cDist=d;closest=en;}});
      if(G.boss){const dx=G.boss.x-fb.x,dy=G.boss.y-fb.y,d=Math.sqrt(dx*dx+dy*dy);if(d<cDist){closest=G.boss;}}
      if(closest){const dx=closest.x-fb.x,dy=closest.y-fb.y,d=Math.sqrt(dx*dx+dy*dy)||1;fb.vx+=(dx/d)*1.2;fb.vy+=(dy/d)*1.2;const sv=Math.sqrt(fb.vx*fb.vx+fb.vy*fb.vy);if(sv>9){fb.vx=fb.vx/sv*9;fb.vy=fb.vy/sv*9;}}
    }
    if(!fb.enemy){fb.trail.push({x:fb.x,y:fb.y});if(fb.trail.length>8)fb.trail.shift();}
    if(fb.x<-40||fb.x>canvas.width+40||fb.y<-80||fb.y>canvas.height+40)return false;
    let hit=false;
    if(!fb.enemy){
      G.enemies.forEach(en=>{
        if(hit)return;const dx=fb.x-en.x,dy=fb.y-en.y;
        if(Math.sqrt(dx*dx+dy*dy)<fb.r+en.r){dealDamage(en,fb.dmg,fb.x,fb.y);hit=true;}
      });
      if(!hit&&G.boss){const dx=fb.x-G.boss.x,dy=fb.y-G.boss.y;if(Math.sqrt(dx*dx+dy*dy)<fb.r+G.boss.w){G.boss.hp-=fb.dmg;shake(4);G.boss.dmgFlash=8;spawnParticles(fb.x,fb.y,12,'#ff5500',3,7);spawnDmgNum(fb.x,fb.y-20,fb.dmg);hit=true;updateBossHUD();if(G.boss.hp<=0)bossDie();}}
    } else {
      if(p.invincible<=0&&p.alive){const dx=fb.x-p.x,dy=fb.y-p.y;if(Math.sqrt(dx*dx+dy*dy)<fb.r+p.w/2){p.hp-=fb.dmg;p.score=Math.max(0,p.score-Math.floor(fb.dmg*0.5));shake(5);spawnParticles(p.x,p.y,7,'#4488ff');flash('rgba(0,30,120,0.35)',100);hit=true;}}
    }
    if(hit&&!fb.enemy)spawnParticles(fb.x,fb.y,10,'#ffaa00',2,5);
    return !hit;
  });

  function dealDamage(en,dmg,fx,fy){
    en.hp-=dmg;en.attackAnim=10;
    SFX.play('hit');
    spawnDmgNum(fx,fy-16,Math.floor(dmg),en.isElite);
    if(p.powers.includes(2)){
      G.enemies.forEach(other=>{if(other!==en){const dx2=other.x-fx,dy2=other.y-fy;if(Math.sqrt(dx2*dx2+dy2*dy2)<110){other.hp-=dmg*0.5;spawnParticles(other.x,other.y,5,'#ff6600');}}});
      shake(7);spawnParticles(fx,fy,25,'#ff7700',4,9);flash('rgba(255,80,0,0.2)',80);
    }
  }

  // ENEMY AI
  G.enemies=G.enemies.filter(en=>{
    en.pulse+=0.05*sm;if(en.attackAnim>0)en.attackAnim--;
    // apply knockback
    if(en.knockTimer>0){en.x+=en.vxKnock*sm;en.y+=en.vyKnock*sm;en.vxKnock*=0.7;en.vyKnock*=0.7;en.knockTimer--;}
    const dx=p.x-en.x,dy=p.y-en.y,dist=Math.sqrt(dx*dx+dy*dy);
    const ndx=dist>0?dx/dist:0,ndy=dist>0?dy/dist:0;

    if(en.behavior==='chase'||en.behavior==='berserker'){
      // berserker: speed multiplied at low HP
      let spMult=1;
      if(en.isBerserker){
        const hpRatio=en.hp/en.maxHp;
        spMult=hpRatio<0.35?2.6:hpRatio<0.6?1.6:1;
        if(hpRatio<0.35&&G.tick%12===0)spawnParticles(en.x,en.y,3,'#ff4400',1,3);
      }
      en.x+=ndx*en.speed*sm*spMult;en.y+=ndy*en.speed*sm*spMult;
    }
    else if(en.behavior==='strafe'){
      en.strafeTimer=(en.strafeTimer||0)+1;if(en.strafeTimer>90){en.strafeDir*=-1;en.strafeTimer=0;}
      const perp={x:-ndy*en.strafeDir,y:ndx*en.strafeDir};
      const approachF=dist>200?0.7:0.2;
      en.x+=(ndx*approachF+perp.x*0.9)*en.speed*sm;en.y+=(ndy*approachF+perp.y*0.9)*en.speed*sm;
      en.shootCD--;
      if(en.shootCD<=0){en.shootCD=55+Math.random()*30;if(dist<520){const a=Math.atan2(dy,dx);G.fireballs.push({x:en.x,y:en.y,vx:Math.cos(a)*4.5,vy:Math.sin(a)*4.5,r:7,dmg:14,trail:[],enemy:true});}}
    }
    else if(en.behavior==='sniper'){
      // keep preferred distance, circle, shoot long range
      const prefDist=en.preferDist||350;
      const diff=dist-prefDist;
      en.x+=ndx*Math.sign(diff)*Math.min(Math.abs(diff)*0.03,en.speed)*sm;
      en.y+=ndy*Math.sign(diff)*Math.min(Math.abs(diff)*0.03,en.speed)*sm;
      // circle
      en.x+=(-ndy)*en.speed*0.5*sm;en.y+=(ndx)*en.speed*0.5*sm;
      en.shootCD--;
      if(en.shootCD<=0&&dist<550){
        en.shootCD=90+Math.random()*40;
        // precise aimed shot
        const lead=0.12;const a=Math.atan2(dy+p.vy*lead,dx+p.vx*lead);
        const spd=6.5;
        G.fireballs.push({x:en.x,y:en.y,vx:Math.cos(a)*spd,vy:Math.sin(a)*spd,r:8,dmg:22,trail:[],enemy:true});
        spawnParticles(en.x,en.y,4,'#00ffaa',1,3);
      }
    }
    else if(en.behavior==='dodge'){
      en.dodgeCd--;let dodged=false;
      if(en.dodgeCd<=0){
        G.fireballs.forEach(fb=>{if(fb.enemy||dodged)return;const fdx=fb.x-en.x,fdy=fb.y-en.y,fd=Math.sqrt(fdx*fdx+fdy*fdy);if(fd<120){en.x+=(-fdy/fd)*45*sm;en.y+=(fdx/fd)*45*sm;en.dodgeCd=25;dodged=true;spawnParticles(en.x,en.y,4,'#ff4400',2,4);}});
      }
      if(!dodged){en.x+=ndx*en.speed*sm;en.y+=ndy*en.speed*sm;}
    }

    en.x=Math.max(-60,Math.min(canvas.width+60,en.x));en.y=Math.max(-60,Math.min(canvas.height+60,en.y));
    if(dist<en.r+p.w/2&&p.invincible<=0&&p.alive&&en.dmg>0){p.hp-=en.dmg*sm;p.score=Math.max(0,p.score-Math.floor(en.dmg*0.3));shake(3);if(p.hp<0)p.hp=0;flash('rgba(200,0,0,0.18)',80);}
    if(en.hp<=0){killEnemy(en);return false;}
    return en.y<canvas.height+120&&en.x>-120&&en.x<canvas.width+120;
  });

  function killEnemy(en){
    p.score+=en.score*(1+Math.floor(p.combo/5)*0.5);// combo multiplier
    G.waveKilled++;p.combo++;p.comboTimer=140;if(p.combo>p.maxCombo)p.maxCombo=p.combo;
    G.worldColor=Math.min(1,G.worldColor+0.009);
    SFX.play('death');
    spawnParticles(en.x,en.y,25,en.color,3,8);
    for(let i=0;i<8;i++) G.particles.push({x:en.x+(Math.random()-.5)*en.r,y:en.y+(Math.random()-.5)*en.r,vx:(Math.random()-.5)*9,vy:-2-Math.random()*6,life:22,maxLife:22,r:2+Math.random()*3,color:'#ffdd00'});
    if(p.powers.includes(4)||Math.random()<0.32) G.orbs.push({x:en.x,y:en.y,r:8,life:220,vx:(Math.random()-.5)*2.2,vy:-2.2});
    if(en.isElite){triggerSlowMo(35);flash('rgba(255,80,0,0.3)',200);shake(8);p.score+=40;}
    if(COMBO_LORE[p.combo])showAlert(COMBO_LORE[p.combo],`${p.combo}x COMBO`,1800);
    updateComboHUD();
  }

  // BOSS AI
  if(G.boss&&G.boss.hp>0){
    const b=G.boss;b.pulse+=0.05*sm;b.spikeAnim+=0.08;if(b.dmgFlash>0)b.dmgFlash--;
    const phase2=b.hp<b.maxHp*0.5;
    b.x+=b.vx*sm;b.y+=b.vy*sm;
    if(b.x<b.w+30||b.x>canvas.width-b.w-30)b.vx*=-1;if(b.y<b.h+30||b.y>canvas.height*0.55)b.vy*=-1;
    b.tentacles.forEach(t=>t.t+=0.045*sm);
    b.shootCD-=sm;
    if(b.shootCD<=0){b.shootCD=phase2?28:48;const a=Math.atan2(p.y-b.y,p.x-b.x);const count=phase2?6:3;for(let i=0;i<count;i++){const spr=(i-(count-1)/2)*0.28;const spd=phase2?5.5:4.5;G.fireballs.push({x:b.x,y:b.y,vx:Math.cos(a+spr)*spd,vy:Math.sin(a+spr)*spd,r:10,dmg:20,trail:[],enemy:true});}SFX.play('bossAttack');}
    if(phase2){b.chargeCD-=sm;if(b.chargeCD<=0){b.chargeCD=100;b.charging=true;b.chargeTarget={x:p.x,y:p.y};}if(b.charging&&b.chargeTarget){const cdx=b.chargeTarget.x-b.x,cdy=b.chargeTarget.y-b.y,cl=Math.sqrt(cdx*cdx+cdy*cdy);b.vx=cdx/cl*7*sm;b.vy=cdy/cl*7*sm;if(cl<65){b.charging=false;shake(12);if(p.invincible<=0&&p.alive){p.hp-=35;flash('rgba(139,0,0,0.6)',150);}}}}
    const bdx=b.x-p.x,bdy=b.y-p.y;if(Math.sqrt(bdx*bdx+bdy*bdy)<b.w+p.w/2&&p.invincible<=0&&p.alive){p.hp-=0.9*sm;shake(4);}
    if(phase2&&!b._phase2alerted){b._phase2alerted=true;showAlert('‚ö† PHASE 2','The Colossus unleashes its true form',2800);}
    updateBossHUD();G.bossArenaGlow=Math.min(1,G.bossArenaGlow+0.01);
  }

  // ORBS
  G.orbs=G.orbs.filter(o=>{o.x+=o.vx*sm;o.y+=o.vy*sm;o.life--;const dx=p.x-o.x,dy=p.y-o.y;if(Math.sqrt(dx*dx+dy*dy)<o.r+p.w/2){p.energy=Math.min(p.maxE,p.energy+14);if(p.powers.includes(4))p.hp=Math.min(p.maxHp,p.hp+10);spawnParticles(o.x,o.y,6,'#00ff88');return false;}return o.life>0;});

  G.particles=G.particles.filter(pt=>{pt.x+=pt.vx*sm;pt.y+=pt.vy*sm;pt.vx*=0.95;pt.vy*=0.95;pt.life-=sm;return pt.life>0;});

  G.embers.forEach(e=>{e.x+=e.vx+Math.sin(G.tick*0.02+e.flicker)*0.4;e.y+=e.vy;e.life-=0.5;e.flicker+=0.05;if(e.y<-10||e.life<=0){e.x=Math.random()*canvas.width;e.y=canvas.height+10;e.life=e.maxLife;}});

  if(!G.bossActive&&G.waveSpawned<G.waveEnemiesTotal){G.spawnTimer+=sm;const rate=Math.max(22,75-G.wave*8);if(G.spawnTimer>=rate){spawnEnemy();G.waveSpawned++;G.spawnTimer=0;}}
  if(!G.bossActive&&G.waveSpawned>=G.waveEnemiesTotal&&G.enemies.length===0&&!G.lastWaveComplete){G.lastWaveComplete=true;setTimeout(()=>{G.lastWaveComplete=false;if(G.wave<5)startWave(G.wave+1);else showVictory();},1000);}

  // HUD
  document.getElementById('ebar').style.width=(p.energy/p.maxE*100)+'%';
  document.getElementById('ebar-glow').style.right=(100-p.energy/p.maxE*100)+'%';
  document.getElementById('hpbar').style.width=(p.hp/p.maxHp*100)+'%';
  document.getElementById('score-val').textContent=Math.floor(p.score).toLocaleString();
  document.getElementById('rebirth-val').textContent=p.rebirths;
  document.getElementById('kills-val').textContent=G.bossActive?'':`${G.waveKilled}/${G.waveEnemiesTotal}`;
  // ability CD icons
  updateAbilityHUD();
}

function updateAbilityHUD(){
  const p=G.p;
  // shoot
  const shootCdPct=Math.min(100,p.shootCD/12*100);
  document.getElementById('ab-shoot-cd').style.height=shootCdPct+'%';
  document.getElementById('ab-shoot').className='ability-icon'+(shootCdPct<5?' ready':'');
  // dash
  const dashCdPct=Math.min(100,p.dashCD/50*100);
  document.getElementById('ab-dash-cd').style.height=dashCdPct+'%';
  document.getElementById('ab-dash').className='ability-icon'+(dashCdPct<5?' ready':'');
  // rebirth
  const rbCdPct=Math.min(100,p.rebirthCD/360*100);
  document.getElementById('ab-rebirth-cd').style.height=rbCdPct+'%';
  document.getElementById('ab-rebirth').className='ability-icon'+(rbCdPct<5&&p.hp<35?' active':(rbCdPct<5?' ready':''));
}
function updateComboHUD(){const p=G.p,el=document.getElementById('combo-disp');if(p.combo>=3){el.textContent=`x${p.combo} COMBO üî•`;el.classList.add('show');}else el.classList.remove('show');}
function updateBossHUD(){if(!G.boss)return;document.getElementById('boss-fill').style.width=(G.boss.hp/G.boss.maxHp*100)+'%';}
function updatePowersHUD(){const p=G.p;if(p.powers.length===0)return;document.getElementById('powers-panel').style.display='block';document.getElementById('powers-list').innerHTML=p.powers.map(i=>`<span class="power-badge">${POWERS[i].icon} ${POWERS[i].name}</span>`).join('');}

function bossDie(){
  const b=G.boss;
  for(let i=0;i<140;i++){const a=Math.PI*2/140*i,sp=4+Math.random()*12;G.particles.push({x:b.x,y:b.y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:110,maxLife:110,r:5+Math.random()*9,color:`hsl(${Math.random()*60},100%,60%)`});}
  G.boss=null;G.bossActive=false;shake(25);flash('rgba(255,215,0,1)',400);
  document.getElementById('boss-hpbar').style.opacity=0;
  showAlert('üî• COLOSSUS DEFEATED','The world begins to heal...',3500);
  G.bossArenaGlow=0;G.p.score+=5000;// boss score burst
  setTimeout(showVictory,1600);
}

// =====================================================
// RENDER
// =====================================================
function render(){
  const c=ctx,wc=G.worldColor,p=G.p;
  const cd=CHAR_DEFS[G.char];
  c.save();c.translate(G.shakeX,G.shakeY);

  // BACKGROUND
  const waveHue=G.wave*8;
  const skyGrd=c.createLinearGradient(0,0,0,canvas.height);
  skyGrd.addColorStop(0,`rgb(${4+wc*24+waveHue*0.3|0},${2+wc*9},${2+wc*3})`);
  skyGrd.addColorStop(1,`rgb(${14+wc*45+waveHue*0.5|0},${6+wc*18},${2+wc*4})`);
  c.fillStyle=skyGrd;c.fillRect(0,0,canvas.width,canvas.height);

  if(G.bossArenaGlow>0){const ag=G.bossArenaGlow*(0.5+0.5*Math.sin(G.tick*0.04));const bg2=c.createRadialGradient(canvas.width/2,0,0,canvas.width/2,0,canvas.width*0.7);bg2.addColorStop(0,`rgba(180,0,0,${ag*0.18})`);bg2.addColorStop(1,'transparent');c.fillStyle=bg2;c.fillRect(0,0,canvas.width,canvas.height);}

  G.bgStars.forEach(s=>{s.t+=s.spd;const starA=0.15+wc*0.55;c.beginPath();c.arc(s.x,s.y,s.r*(0.8+0.2*Math.sin(s.t)),0,Math.PI*2);c.fillStyle=`rgba(255,${180+wc*75|0},${100+wc*100|0},${starA})`;c.fill();});

  G.embers.forEach(e=>{const ea=Math.min(1,(e.life/e.maxLife))*0.7;const pulse=0.7+0.3*Math.sin(e.flicker*3);c.beginPath();c.arc(e.x,e.y,e.r*pulse,0,Math.PI*2);c.fillStyle=`rgba(255,${100+wc*80|0},0,${ea*pulse})`;c.fill();const eg2=c.createRadialGradient(e.x,e.y,0,e.x,e.y,e.r*3);eg2.addColorStop(0,`rgba(255,80,0,${ea*0.2})`);eg2.addColorStop(1,'transparent');c.fillStyle=eg2;c.beginPath();c.arc(e.x,e.y,e.r*3,0,Math.PI*2);c.fill();});

  const glvGrd=c.createLinearGradient(0,canvas.height-100,0,canvas.height);glvGrd.addColorStop(0,'transparent');glvGrd.addColorStop(1,`rgba(255,${50+wc*80|0},0,${0.08+wc*0.35})`);c.fillStyle=glvGrd;c.fillRect(0,canvas.height-100,canvas.width,100);

  for(let i=0;i<4;i++){const yy=canvas.height*0.55+Math.sin(G.tick*0.018+i*1.4)*35;const hg=c.createLinearGradient(0,yy-18,0,yy+18);hg.addColorStop(0,'transparent');hg.addColorStop(0.5,`rgba(255,70,0,${0.03+wc*0.06})`);hg.addColorStop(1,'transparent');c.fillStyle=hg;c.fillRect(0,yy-18,canvas.width,36);}

  // KNOCKBACK RINGS
  G.knockbackRings.forEach(r=>{
    const a=r.life/r.maxLife;
    c.beginPath();c.arc(r.x,r.y,r.r,0,Math.PI*2);
    c.strokeStyle=`rgba(255,200,50,${a*0.8})`;c.lineWidth=3*(1-r.r/r.maxR)+1;c.stroke();
  });

  G.particles.forEach(pt=>{const a=pt.life/pt.maxLife;c.beginPath();c.arc(pt.x,pt.y,pt.r*a,0,Math.PI*2);c.fillStyle=hexAlpha(pt.color,a*0.88);c.fill();});
  G.orbs.forEach(o=>{const a=o.life/220;const og=c.createRadialGradient(o.x,o.y,0,o.x,o.y,o.r*2.5);og.addColorStop(0,`rgba(0,255,120,${a})`);og.addColorStop(1,'transparent');c.fillStyle=og;c.beginPath();c.arc(o.x,o.y,o.r*2.5,0,Math.PI*2);c.fill();c.beginPath();c.arc(o.x,o.y,o.r*0.55,0,Math.PI*2);c.fillStyle=`rgba(200,255,220,${a})`;c.fill();});

  // ENEMIES
  G.enemies.forEach(en=>{
    const pulse=Math.sin(en.pulse)*0.1;const hitFlash=en.attackAnim>0?(en.attackAnim/10):0;
    c.beginPath();c.ellipse(en.x,en.y+en.r*0.85,en.r*0.85,en.r*0.18,0,0,Math.PI*2);c.fillStyle='rgba(0,0,0,0.3)';c.fill();
    const glowR=en.isElite?en.r*3.5:en.r*2;
    const eg=c.createRadialGradient(en.x,en.y,0,en.x,en.y,glowR);
    eg.addColorStop(0,hitFlash>0.3?'rgba(255,255,100,0.3)':en.color+'55');eg.addColorStop(1,'transparent');
    c.fillStyle=eg;c.beginPath();c.arc(en.x,en.y,glowR,0,Math.PI*2);c.fill();
    c.beginPath();c.arc(en.x,en.y,en.r*(1+pulse),0,Math.PI*2);
    const bg=c.createRadialGradient(en.x-en.r*0.3,en.y-en.r*0.3,0,en.x,en.y,en.r);
    bg.addColorStop(0,hitFlash>0?'#ffffff':'#fff8');bg.addColorStop(0.25,en.color);bg.addColorStop(1,'#110000');
    c.fillStyle=bg;c.fill();
    if(en.isElite){c.beginPath();c.arc(en.x,en.y,en.r+5,0,Math.PI*2);c.strokeStyle=`rgba(255,200,50,${0.5+0.4*Math.sin(en.pulse*3)})`;c.lineWidth=2;c.stroke();for(let s=0;s<6;s++){const sa=s/6*Math.PI*2+en.pulse*0.5;c.beginPath();c.moveTo(en.x+Math.cos(sa)*(en.r+4),en.y+Math.sin(sa)*(en.r+4));c.lineTo(en.x+Math.cos(sa)*(en.r+12),en.y+Math.sin(sa)*(en.r+12));c.strokeStyle='rgba(255,150,0,0.8)';c.lineWidth=2;c.stroke();}}
    if(en.behavior==='strafe'){c.beginPath();c.arc(en.x,en.y,en.r+5,0,Math.PI*2);c.strokeStyle='rgba(0,120,255,0.5)';c.lineWidth=2;c.stroke();}
    // sniper crosshair indicator
    if(en.isSniperType){
      c.strokeStyle='rgba(0,255,180,0.5)';c.lineWidth=1.5;
      c.beginPath();c.moveTo(en.x-en.r-8,en.y);c.lineTo(en.x+en.r+8,en.y);c.stroke();
      c.beginPath();c.moveTo(en.x,en.y-en.r-8);c.lineTo(en.x,en.y+en.r+8);c.stroke();
      c.beginPath();c.arc(en.x,en.y,en.r+8,0,Math.PI*2);c.strokeStyle='rgba(0,255,180,0.25)';c.stroke();
    }
    // berserker rage aura when low HP
    if(en.isBerserker&&en.hp/en.maxHp<0.35){
      const ra=0.4+0.3*Math.sin(G.tick*0.2);
      c.beginPath();c.arc(en.x,en.y,en.r*2.2,0,Math.PI*2);
      c.strokeStyle=`rgba(255,80,0,${ra})`;c.lineWidth=2.5;c.stroke();
    }
    drawEyes(c,en.x,en.y,en.r);
    const bw=en.r*2.6,bh=4;c.fillStyle='rgba(0,0,0,0.65)';c.fillRect(en.x-bw/2,en.y-en.r-15,bw,bh);c.fillStyle=`hsl(${en.hp/en.maxHp*120},100%,50%)`;c.fillRect(en.x-bw/2,en.y-en.r-15,bw*(en.hp/en.maxHp),bh);
  });

  // BOSS
  if(G.boss){
    const b=G.boss;const bp=Math.sin(b.pulse)*0.1;const phase2=b.hp<b.maxHp*0.5;
    const aFloor=c.createRadialGradient(b.x,canvas.height,0,b.x,canvas.height,300);aFloor.addColorStop(0,`rgba(180,0,0,${0.12+0.08*Math.sin(G.tick*0.05)})`);aFloor.addColorStop(1,'transparent');c.fillStyle=aFloor;c.fillRect(0,0,canvas.width,canvas.height);
    const bGl=c.createRadialGradient(b.x,b.y,0,b.x,b.y,b.w*3.5);bGl.addColorStop(0,phase2?'rgba(255,30,0,0.28)':'rgba(160,0,0,0.22)');bGl.addColorStop(1,'transparent');c.fillStyle=bGl;c.beginPath();c.arc(b.x,b.y,b.w*3.5,0,Math.PI*2);c.fill();
    b.tentacles.forEach(t=>{const ta=t.angle+Math.sin(t.t)*0.55;const wave=Math.sin(b.spikeAnim+t.angle*3)*15;const ex=b.x+Math.cos(ta)*(b.w+t.len+wave);const ey=b.y+Math.sin(ta)*(b.w+t.len+wave);c.beginPath();c.moveTo(b.x+Math.cos(ta)*b.w,b.y+Math.sin(ta)*b.w);c.quadraticCurveTo(b.x+Math.cos(ta)*(b.w+38),b.y+Math.sin(ta)*(b.w+38),ex,ey);c.strokeStyle=phase2?`rgba(255,${30+Math.sin(b.spikeAnim)*50|0},0,0.7)`:'rgba(120,0,0,0.6)';c.lineWidth=9;c.stroke();c.beginPath();c.arc(ex,ey,7,0,Math.PI*2);c.fillStyle=phase2?'#ff2200':'#880000';c.fill();});
    c.beginPath();c.arc(b.x,b.y,b.w*(1+bp),0,Math.PI*2);const bBg=c.createRadialGradient(b.x-b.w*0.28,b.y-b.w*0.28,0,b.x,b.y,b.w);bBg.addColorStop(0,b.dmgFlash>0?'#ffffff':phase2?'#ff3300':'#882200');bBg.addColorStop(0.45,phase2?'#660000':'#440000');bBg.addColorStop(1,'#0f0000');c.fillStyle=bBg;c.fill();c.strokeStyle=phase2?'rgba(255,120,0,0.9)':'rgba(160,0,0,0.6)';c.lineWidth=3;c.stroke();
    c.fillStyle='#ffff00';c.beginPath();c.arc(b.x-20,b.y-14,9,0,Math.PI*2);c.fill();c.beginPath();c.arc(b.x+20,b.y-14,9,0,Math.PI*2);c.fill();c.fillStyle='#000';c.beginPath();c.arc(b.x-20,b.y-14,4,0,Math.PI*2);c.fill();c.beginPath();c.arc(b.x+20,b.y-14,4,0,Math.PI*2);c.fill();
    if(phase2){c.fillStyle='rgba(255,0,0,0.6)';c.beginPath();c.arc(b.x,b.y+18,18,0,Math.PI);c.fill();c.strokeStyle='rgba(255,80,0,0.4)';c.lineWidth=1.5;for(let i=0;i<4;i++){const ca=i/4*Math.PI*2+b.pulse;c.beginPath();c.moveTo(b.x,b.y);c.lineTo(b.x+Math.cos(ca)*(b.w*0.9),b.y+Math.sin(ca)*(b.w*0.9));c.stroke();}}
  }

  // FIREBALLS
  G.fireballs.forEach(fb=>{
    const isEnemy=fb.enemy;
    if(!isEnemy&&fb.trail&&fb.trail.length>1){for(let i=1;i<fb.trail.length;i++){const t=fb.trail[i];const ta=(1-(i/fb.trail.length))*0.6;const tr=fb.r*(1-i/fb.trail.length)*1.8;c.beginPath();c.arc(t.x,t.y,tr,0,Math.PI*2);c.fillStyle=`rgba(255,${80+i*20|0},0,${ta})`;c.fill();}if(fb.trail.length>3){const pt=fb.trail[fb.trail.length-1];c.beginPath();c.arc(pt.x,pt.y,fb.r*2.5,0,Math.PI*2);c.fillStyle='rgba(60,30,10,0.12)';c.fill();}}
    // homing fireballs get purple tint
    const homingTint=fb.homing;
    const col1=homingTint?'rgba(220,100,255,0.95)':isEnemy?'rgba(30,100,255,0.85)':'rgba(255,180,0,0.95)';
    const col2=homingTint?'rgba(150,0,255,0.45)':isEnemy?'rgba(0,50,200,0.4)':'rgba(255,50,0,0.45)';
    const outerGrd=c.createRadialGradient(fb.x,fb.y,0,fb.x,fb.y,fb.r*4);outerGrd.addColorStop(0,col2);outerGrd.addColorStop(1,'transparent');c.fillStyle=outerGrd;c.beginPath();c.arc(fb.x,fb.y,fb.r*4,0,Math.PI*2);c.fill();
    const coreGrd=c.createRadialGradient(fb.x,fb.y,0,fb.x,fb.y,fb.r*2);coreGrd.addColorStop(0,col1);coreGrd.addColorStop(0.5,col2);coreGrd.addColorStop(1,'transparent');c.fillStyle=coreGrd;c.beginPath();c.arc(fb.x,fb.y,fb.r*2,0,Math.PI*2);c.fill();
    c.beginPath();c.arc(fb.x,fb.y,fb.r*0.55,0,Math.PI*2);c.fillStyle=homingTint?'#f0ccff':isEnemy?'#cce8ff':'#fffde0';c.fill();
  });

  // PLAYER
  if(p.alive||p.invincible>0){
    const flicker=p.invincible>0&&Math.floor(p.invincible/5)%2===0;
    if(!flicker){
      const auraStr=0.2+wc*0.25+(p.rebirthGlow/120)*0.6;
      // character-specific aura color
      const aura=c.createRadialGradient(p.x,p.y,0,p.x,p.y,p.w*3.2);
      aura.addColorStop(0,cd.auraColor+auraStr+')');aura.addColorStop(0.5,cd.auraColor2+(auraStr*0.35)+')');aura.addColorStop(1,'transparent');
      c.fillStyle=aura;c.beginPath();c.arc(p.x,p.y,p.w*3.2,0,Math.PI*2);c.fill();
      const idleBob=Math.sin(p.idlePhase)*3;const wgt=Math.sin(p.auraPhase*0.8);const dashFlare=p.dashFrame<12?1-p.dashFrame/12:0;
      c.save();c.translate(p.x,p.y+idleBob);
      p.trail.forEach((t,i)=>{const a=(1-i/p.trail.length)*0.32;c.beginPath();c.arc(t.x-p.x,t.y-p.y-idleBob,p.w/2*(1-i/p.trail.length)*0.9,0,Math.PI*2);c.fillStyle=hexAlpha(cd.auraColor2.slice(0,-1),(a));c.fill();});

      // character-specific visuals
      if(G.char==='phoenix'){
        // standard wings
        const wSpan=p.w*(1.9+dashFlare*1.4);const wHeight=p.h*(0.45+dashFlare*0.5+wgt*0.08);
        c.beginPath();c.moveTo(0,-5);c.quadraticCurveTo(-wSpan,-wHeight,-wSpan*1.05,-2);c.quadraticCurveTo(-p.w*0.85,-1,0,5);const wingL=c.createLinearGradient(-wSpan,0,0,0);wingL.addColorStop(0,`rgba(255,${60+wc*70|0},0,${0.35+dashFlare*0.5})`);wingL.addColorStop(1,'rgba(255,180,50,0.8)');c.fillStyle=wingL;c.fill();
        c.beginPath();c.moveTo(0,-5);c.quadraticCurveTo(wSpan,-wHeight,wSpan*1.05,-2);c.quadraticCurveTo(p.w*0.85,-1,0,5);const wingR=c.createLinearGradient(wSpan,0,0,0);wingR.addColorStop(0,`rgba(255,${60+wc*70|0},0,${0.35+dashFlare*0.5})`);wingR.addColorStop(1,'rgba(255,180,50,0.8)');c.fillStyle=wingR;c.fill();
        for(let f=0;f<3;f++){const fa=0.3+f*0.25;const fr=p.w*(1.2+dashFlare*0.9-f*0.3);c.beginPath();c.moveTo(0,-3);c.lineTo(-fr*Math.cos(fa),-fr*0.5*Math.sin(fa));c.strokeStyle=`rgba(255,220,100,${0.18+dashFlare*0.35})`;c.lineWidth=1.5;c.stroke();c.beginPath();c.moveTo(0,-3);c.lineTo(fr*Math.cos(fa),-fr*0.5*Math.sin(fa));c.stroke();}
      } else if(G.char==='assassin'){
        // twin razor blades
        for(let side of[-1,1]){
          const sw=p.w*(1.2+dashFlare*2);const sh=p.h*(0.2+dashFlare*0.25);
          c.save();c.rotate(side*0.3);
          c.beginPath();c.moveTo(0,-3);c.lineTo(side*sw,-sh*0.5);c.lineTo(side*sw*0.9,sh*0.5);c.closePath();
          const wg=c.createLinearGradient(0,0,side*sw,0);wg.addColorStop(0,'rgba(220,100,255,0.8)');wg.addColorStop(1,`rgba(180,0,255,${0.3+dashFlare*0.5})`);c.fillStyle=wg;c.fill();
          c.restore();
        }
      } else if(G.char==='titan'){
        // heavy mantle / lava shoulders
        const tw=p.w*(1.4+dashFlare*0.8);const th=p.h*(0.6+dashFlare*0.4+wgt*0.05);
        c.beginPath();c.moveTo(-tw,-th*0.5);c.lineTo(0,-th);c.lineTo(tw,-th*0.5);c.lineTo(tw*0.5,p.h*0.3);c.lineTo(-tw*0.5,p.h*0.3);c.closePath();
        const mg=c.createLinearGradient(-tw,0,tw,0);mg.addColorStop(0,`rgba(255,30,0,${0.5+dashFlare*0.4})`);mg.addColorStop(0.5,'rgba(255,100,0,0.8)');mg.addColorStop(1,`rgba(255,30,0,${0.5+dashFlare*0.4})`);c.fillStyle=mg;c.fill();
        // lava cracks
        c.strokeStyle='rgba(255,220,0,0.5)';c.lineWidth=1.5;
        for(let i=0;i<4;i++){const ca=i/4*Math.PI*2+p.auraPhase*0.2;c.beginPath();c.moveTo(0,0);c.lineTo(Math.cos(ca)*tw*0.7,Math.sin(ca)*th*0.5);c.stroke();}
      }

      if(p.rebirthGlow>0){const rg=p.rebirthGlow/120;c.beginPath();c.arc(0,0,p.w*1.5+rg*p.w,0,Math.PI*2);c.strokeStyle=`rgba(255,220,100,${rg*0.8})`;c.lineWidth=3*rg;c.stroke();}

      // body (character-specific color)
      c.beginPath();c.arc(0,0,p.w/2,0,Math.PI*2);
      const bodyHue=G.char==='assassin'?270:G.char==='titan'?0:18;
      const pbg=c.createRadialGradient(-5,-5,0,0,0,p.w/2);pbg.addColorStop(0,'#fffce0');pbg.addColorStop(0.35,G.char==='assassin'?'#cc88ff':G.char==='titan'?'#ff4400':'#ffd700');pbg.addColorStop(1,`hsl(${bodyHue+wc*35},100%,38%)`);c.fillStyle=pbg;c.fill();
      c.fillStyle='#ffd700';c.beginPath();c.moveTo(0,-p.h/2-9);c.lineTo(-5,-p.h/2+2);c.lineTo(5,-p.h/2+2);c.fill();
      const eyeCol=G.char==='assassin'?'rgba(220,0,255,0.95)':G.char==='titan'?'rgba(255,30,0,0.95)':'rgba(255,20,0,0.95)';
      c.fillStyle=eyeCol;c.beginPath();c.arc(-6,-5,4.5,0,Math.PI*2);c.fill();c.beginPath();c.arc(6,-5,4.5,0,Math.PI*2);c.fill();c.fillStyle='#fff9';c.beginPath();c.arc(-5,-6,1.8,0,Math.PI*2);c.fill();c.beginPath();c.arc(7,-6,1.8,0,Math.PI*2);c.fill();
      c.restore();
    }
  }

  if(p.dashCD>0){c.beginPath();c.arc(p.x,p.y,p.w+5,-Math.PI/2,-Math.PI/2+Math.PI*2*(1-p.dashCD/50));c.strokeStyle='rgba(255,215,0,0.5)';c.lineWidth=2;c.stroke();}

  // WORLD TRANSFORMATION BAR
  const barX=canvas.width/2-130,barY=canvas.height-26,barW=260,barH=5;
  c.fillStyle='rgba(0,0,0,0.5)';c.fillRect(barX,barY,barW,barH);
  const wBar=c.createLinearGradient(barX,0,barX+barW,0);wBar.addColorStop(0,'#444');wBar.addColorStop(0.45,'#ff6600');wBar.addColorStop(1,'#ffd700');c.fillStyle=wBar;c.fillRect(barX,barY,barW*wc,barH);
  if(wc>0.02){const tipX=barX+barW*wc;const tipG=c.createRadialGradient(tipX,barY+2,0,tipX,barY+2,12);tipG.addColorStop(0,'rgba(255,220,100,0.7)');tipG.addColorStop(1,'transparent');c.fillStyle=tipG;c.fillRect(tipX-12,barY-5,24,14);}
  c.fillStyle='rgba(255,180,80,0.35)';c.font='10px Rajdhani,sans-serif';c.textAlign='center';c.fillText('WORLD TRANSFORMATION',canvas.width/2,barY-5);

  if(p.hp<30&&p.rebirths<3&&p.rebirthCD<=0){const ba=0.5+0.5*Math.sin(G.tick*0.12);c.fillStyle=`rgba(255,90,0,${ba})`;c.font='bold 14px Rajdhani,sans-serif';c.textAlign='center';c.fillText('‚ö° Press E ‚Äî REBIRTH BURST',canvas.width/2,canvas.height-46);}

  c.restore();
}

function drawEyes(c,x,y,r){c.fillStyle='#ff0';c.beginPath();c.arc(x-r*0.3,y-r*0.2,r*0.2,0,Math.PI*2);c.fill();c.beginPath();c.arc(x+r*0.3,y-r*0.2,r*0.2,0,Math.PI*2);c.fill();c.fillStyle='#000';c.beginPath();c.arc(x-r*0.3,y-r*0.2,r*0.09,0,Math.PI*2);c.fill();c.beginPath();c.arc(x+r*0.3,y-r*0.2,r*0.09,0,Math.PI*2);c.fill();}
function hexAlpha(color,a){if(color.startsWith('#')){const r=parseInt(color.slice(1,3),16),g=parseInt(color.slice(3,5),16),b=parseInt(color.slice(5,7),16);return `rgba(${r},${g},${b},${a})`;}if(color.startsWith('hsl')){return color.replace('hsl','hsla').replace(')',`,${a})`);}return color;}

function showGameOver(){
  running=false;paused=false;document.getElementById('pause-overlay').classList.remove('show');
  SFX.stopMusic();
  document.getElementById('go-score').textContent=`Score: ${Math.floor(G.p.score).toLocaleString()}`;
  document.getElementById('go-wave').textContent=`Wave ${G.wave} ¬∑ Best Combo: x${G.p.maxCombo} ¬∑ Rebirths: ${G.p.rebirths}`;
  showOverlay('gameover-overlay');
}
function showVictory(){
  running=false;paused=false;document.getElementById('pause-overlay').classList.remove('show');
  SFX.stopMusic();
  document.getElementById('vic-score').textContent=`Final Score: ${Math.floor(G.p.score).toLocaleString()}`;
  document.getElementById('vic-combo').textContent=`Best Combo: x${G.p.maxCombo} ¬∑ Rebirths: ${G.p.rebirths}`;
  showOverlay('victory-overlay');
}
function restartGame(){
  paused=false;document.getElementById('pause-overlay').classList.remove('show');
  ['rebirth-overlay','gameover-overlay','victory-overlay','boss-intro'].forEach(id=>document.getElementById(id).style.display='none');
  document.getElementById('boss-hpbar').style.opacity=0;
  document.getElementById('powers-panel').style.display='none';
  document.getElementById('powers-list').innerHTML='';
  initGame();
}
function backToSlides(){
  running=false;paused=false;if(raf)cancelAnimationFrame(raf);
  SFX.stopMusic();
  document.getElementById('pause-overlay').classList.remove('show');
  ['rebirth-overlay','gameover-overlay','victory-overlay','boss-intro'].forEach(id=>document.getElementById(id).style.display='none');
  document.getElementById('boss-hpbar').style.opacity=0;
  document.getElementById('game').style.display='none';
  document.getElementById('char-select').style.display='none';
  document.getElementById('presentation').style.display='block';
  document.getElementById('nav').style.display='flex';
  goTo(0);
}
window.addEventListener('resize',()=>{if(canvas&&document.getElementById('game').style.display==='block'){canvas.width=window.innerWidth;canvas.height=window.innerHeight;}});

// =====================================================
// ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  SOUND SYSTEM  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
// Pure WebAudio ‚Äî zero external dependencies
// =====================================================
const SFX = (function(){
  // ---- Volume knobs (0.0 ‚Äì 1.0) ----
  const VOL = {
    master : 0.72,
    music  : 0.28,
    shoot  : 0.18,
    hit    : 0.22,
    death  : 0.30,
    dash   : 0.24,
    rebirth: 0.55,
    bossAtk: 0.32,
    bossDgr: 0.60,
    ui     : 0.30,
    lowHp  : 0.55,
    hover  : 0.08,
  };

  let ctx = null;
  let muted = false;
  let musicNode = null; // holds the current music oscillator graph
  let musicGain = null;
  let musicRunning = false;
  let _hoverThrottle = 0;

  function getCtx(){
    if(!ctx) ctx = new (window.AudioContext||window.webkitAudioContext)();
    if(ctx.state==='suspended') ctx.resume();
    return ctx;
  }

  // Core tone builder
  function tone(freq, type, duration, vol, attack=0.005, decay=0.08, startTime=null){
    const ac = getCtx();
    const now = startTime !== null ? startTime : ac.currentTime;
    const osc = ac.createOscillator();
    const gain = ac.createGain();
    osc.connect(gain); gain.connect(ac.destination);
    osc.type = type;
    osc.frequency.setValueAtTime(freq, now);
    gain.gain.setValueAtTime(0, now);
    gain.gain.linearRampToValueAtTime(vol * VOL.master, now + attack);
    gain.gain.exponentialRampToValueAtTime(0.0001, now + duration);
    osc.start(now);
    osc.stop(now + duration + 0.02);
    return {osc, gain, ac, now};
  }

  function noise(duration, vol, filterFreq=2000){
    const ac = getCtx();
    const now = ac.currentTime;
    const bufLen = ac.sampleRate * duration;
    const buf = ac.createBuffer(1, bufLen, ac.sampleRate);
    const data = buf.getChannelData(0);
    for(let i=0;i<bufLen;i++) data[i]=(Math.random()*2-1);
    const src = ac.createBufferSource();
    src.buffer = buf;
    const filter = ac.createBiquadFilter();
    filter.type = 'bandpass';
    filter.frequency.value = filterFreq;
    filter.Q.value = 0.8;
    const gain = ac.createGain();
    src.connect(filter); filter.connect(gain); gain.connect(ac.destination);
    gain.gain.setValueAtTime(vol * VOL.master, now);
    gain.gain.exponentialRampToValueAtTime(0.0001, now + duration);
    src.start(now); src.stop(now + duration + 0.02);
  }

  // ---- SYNTHESIZED SFX RECIPES ----
  const sounds = {
    shoot(){
      const ac = getCtx(); const now = ac.currentTime;
      tone(520,'sawtooth',0.08, VOL.shoot*0.8);
      tone(320,'square',0.12,   VOL.shoot*0.5, 0.002, 0.1, now+0.01);
    },
    hit(){
      const ac = getCtx(); const now = ac.currentTime;
      noise(0.06, VOL.hit*0.9, 1800);
      tone(180,'square',0.07, VOL.hit*0.6, 0.001, 0.06);
    },
    death(){
      const ac = getCtx(); const now = ac.currentTime;
      noise(0.15, VOL.death*0.8, 600);
      tone(160,'sawtooth',0.18, VOL.death*0.7, 0.002, 0.16);
      tone(80,'sawtooth',0.14,  VOL.death*0.5, 0.004, 0.2, now+0.05);
    },
    dash(){
      const ac = getCtx(); const now = ac.currentTime;
      const osc = ac.createOscillator(); const g = ac.createGain();
      osc.connect(g); g.connect(ac.destination);
      osc.type = 'sawtooth';
      osc.frequency.setValueAtTime(900, now);
      osc.frequency.exponentialRampToValueAtTime(200, now+0.18);
      g.gain.setValueAtTime(VOL.dash * VOL.master, now);
      g.gain.exponentialRampToValueAtTime(0.0001, now+0.18);
      osc.start(now); osc.stop(now+0.2);
      noise(0.1, VOL.dash*0.4, 3000);
    },
    rebirth(){
      const ac = getCtx(); const now = ac.currentTime;
      // ascending harmonic sweep
      [220,330,440,550,660,880].forEach((f,i)=>{
        tone(f,'sine',0.35, VOL.rebirth*0.5, 0.02,0.3, now+i*0.07);
        tone(f*1.5,'triangle',0.2, VOL.rebirth*0.3, 0.01,0.25, now+i*0.07+0.03);
      });
      noise(0.6, VOL.rebirth*0.3, 400);
    },
    bossAttack(){
      const ac = getCtx(); const now = ac.currentTime;
      tone(110,'sawtooth',0.22, VOL.bossAtk*0.9, 0.001, 0.2);
      tone(80,'square',0.18,    VOL.bossAtk*0.7, 0.002, 0.25, now+0.02);
      noise(0.12, VOL.bossAtk*0.5, 300);
    },
    bossDanger(){
      const ac = getCtx(); const now = ac.currentTime;
      // dramatic low boom + warning stabs
      [0,0.18,0.36].forEach(delay=>{
        tone(55,'sawtooth',0.5, VOL.bossDgr*0.7, 0.01,0.45, now+delay);
        tone(110,'square',0.3,  VOL.bossDgr*0.5, 0.005,0.4, now+delay+0.05);
      });
      noise(0.7, VOL.bossDgr*0.45, 200);
      // high warning blip
      tone(880,'sine',0.1, VOL.bossDgr*0.6, 0.005,0.08, now+0.55);
      tone(1100,'sine',0.1,VOL.bossDgr*0.6, 0.005,0.08, now+0.65);
    },
    ui(){
      const ac = getCtx(); const now = ac.currentTime;
      tone(660,'sine',0.07, VOL.ui*0.9, 0.003,0.06);
      tone(880,'sine',0.06, VOL.ui*0.7, 0.003,0.05, now+0.04);
    },
    lowHp(){
      const ac = getCtx(); const now = ac.currentTime;
      // urgent repeating warning beeps
      [0,0.25,0.5].forEach(d=>{
        tone(440,'square',0.12, VOL.lowHp*0.8, 0.005,0.1, now+d);
        tone(330,'square',0.08, VOL.lowHp*0.6, 0.005,0.08, now+d+0.06);
      });
    },
    hover(){
      // very subtle tick
      const ac = getCtx(); const now = ac.currentTime;
      tone(1200,'sine',0.03, VOL.hover*0.5, 0.001,0.025);
    },
  };

  // ---- BACKGROUND MUSIC ENGINE ----
  // 5 procedurally generated music styles
  let currentMusicStyle = 'epic'; // default

  function makeMusicGain(ac, fadeIn=2.5){
    const g = ac.createGain();
    g.gain.setValueAtTime(0, ac.currentTime);
    g.gain.linearRampToValueAtTime(VOL.music * VOL.master, ac.currentTime + fadeIn);
    g.connect(ac.destination);
    return g;
  }

  // ‚îÄ‚îÄ STYLE 1: Epic Battle (original fire drone + driving beat) ‚îÄ‚îÄ
  function buildMusic_epic(){
    const ac = getCtx();
    musicGain = makeMusicGain(ac);
    const nodes = [], now = ac.currentTime;
    // Deep drone bass
    [[55,57],[82,84],[110,113]].forEach(([f1,f2])=>{
      [f1,f2].forEach(f=>{
        const osc=ac.createOscillator(),g=ac.createGain(),lfo=ac.createOscillator(),lfoG=ac.createGain();
        osc.type='sawtooth'; osc.frequency.value=f;
        lfo.type='sine'; lfo.frequency.value=0.12+Math.random()*0.06;
        lfoG.gain.value=0.018; lfo.connect(lfoG); lfoG.connect(g.gain);
        g.gain.value=0.055; osc.connect(g); g.connect(musicGain);
        osc.start(now); lfo.start(now); nodes.push(osc,lfo);
      });
    });
    // Shimmering harmonics
    [440,550,660,770].forEach((f,i)=>{
      const osc=ac.createOscillator(),g=ac.createGain(),lfo=ac.createOscillator(),lfoG=ac.createGain();
      osc.type='sine'; osc.frequency.value=f;
      lfo.type='sine'; lfo.frequency.value=0.08+i*0.03;
      lfoG.gain.value=0.012; lfo.connect(lfoG); lfoG.connect(g.gain);
      g.gain.value=0.022; osc.connect(g); g.connect(musicGain);
      osc.start(now); lfo.start(now); nodes.push(osc,lfo);
    });
    // Beat pulses
    function sp(delay,freq,vol,dur){
      const osc=ac.createOscillator(),g=ac.createGain();
      osc.type='triangle'; osc.frequency.value=freq;
      g.gain.setValueAtTime(0,now+delay); g.gain.linearRampToValueAtTime(vol,now+delay+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001,now+delay+dur);
      osc.connect(g); g.connect(musicGain); osc.start(now+delay); osc.stop(now+delay+dur+0.05);
    }
    const bpm=72,beat=60/bpm;
    for(let bar=0;bar<16;bar++){
      const b=bar*beat*4;
      sp(b,60,0.09,beat*0.4); sp(b+beat*2,55,0.06,beat*0.3);
      sp(b+beat,220,0.035,beat*0.2); sp(b+beat*3,220,0.028,beat*0.2);
      if(bar%2===0) sp(b+beat*1.5,440,0.022,beat*0.15);
      if(bar%4===3) sp(b+beat*3.5,880,0.018,beat*0.1);
    }
    // Crackle noise
    const dur=beat*4*16+2,bufLen=Math.ceil(ac.sampleRate*dur);
    const buf=ac.createBuffer(1,bufLen,ac.sampleRate),data=buf.getChannelData(0);
    for(let i=0;i<bufLen;i++) data[i]=(Math.random()*2-1)*0.012;
    const crackle=ac.createBufferSource(); crackle.buffer=buf;
    const cf=ac.createBiquadFilter(); cf.type='lowpass'; cf.frequency.value=800;
    crackle.connect(cf); cf.connect(musicGain); crackle.start(now); nodes.push(crackle);
    musicNode={nodes,gain:musicGain,startTime:now}; musicRunning=true;
  }

  // ‚îÄ‚îÄ STYLE 2: Ambient Drone (slow evolving pads, no beat) ‚îÄ‚îÄ
  function buildMusic_ambient(){
    const ac = getCtx();
    musicGain = makeMusicGain(ac, 4);
    const nodes = [], now = ac.currentTime;
    // Slow pad layers in fifths
    [[65,97.5],[87,130.5],[130,195],[174,260]].forEach(([f1,f2],i)=>{
      [f1,f2].forEach(f=>{
        const osc=ac.createOscillator(),g=ac.createGain(),lfo=ac.createOscillator(),lfoG=ac.createGain();
        osc.type='sine'; osc.frequency.value=f;
        lfo.type='sine'; lfo.frequency.value=0.04+i*0.015+Math.random()*0.02;
        lfoG.gain.value=0.025; lfo.connect(lfoG); lfoG.connect(g.gain);
        g.gain.value=0.038+i*0.004; osc.connect(g); g.connect(musicGain);
        osc.start(now); lfo.start(now); nodes.push(osc,lfo);
      });
    });
    // Evolving shimmer
    [260,390,520,650,780].forEach((f,i)=>{
      const osc=ac.createOscillator(),g=ac.createGain(),lfo=ac.createOscillator(),lfoG=ac.createGain();
      osc.type='sine'; osc.frequency.value=f+Math.random()*8-4;
      lfo.type='sine'; lfo.frequency.value=0.03+i*0.018;
      lfoG.gain.value=0.008; lfo.connect(lfoG); lfoG.connect(g.gain);
      g.gain.value=0.014; osc.connect(g); g.connect(musicGain);
      osc.start(now); lfo.start(now); nodes.push(osc,lfo);
    });
    // Very slow deep sub
    [32,48].forEach(f=>{
      const osc=ac.createOscillator(),g=ac.createGain(),lfo=ac.createOscillator(),lfoG=ac.createGain();
      osc.type='sine'; osc.frequency.value=f;
      lfo.type='sine'; lfo.frequency.value=0.022;
      lfoG.gain.value=0.02; lfo.connect(lfoG); lfoG.connect(g.gain);
      g.gain.value=0.06; osc.connect(g); g.connect(musicGain);
      osc.start(now); lfo.start(now); nodes.push(osc,lfo);
    });
    musicNode={nodes,gain:musicGain,startTime:now}; musicRunning=true;
  }

  // ‚îÄ‚îÄ STYLE 3: Dark Dungeon (dissonant low drones + irregular thuds) ‚îÄ‚îÄ
  function buildMusic_dungeon(){
    const ac = getCtx();
    musicGain = makeMusicGain(ac, 3);
    const nodes = [], now = ac.currentTime;
    // Dissonant drone cluster
    [55,58,73,77,110].forEach(f=>{
      const osc=ac.createOscillator(),g=ac.createGain(),lfo=ac.createOscillator(),lfoG=ac.createGain();
      osc.type='sawtooth'; osc.frequency.value=f;
      lfo.type='sine'; lfo.frequency.value=0.07+Math.random()*0.05;
      lfoG.gain.value=0.022; lfo.connect(lfoG); lfoG.connect(g.gain);
      g.gain.value=0.045; osc.connect(g); g.connect(musicGain);
      osc.start(now); lfo.start(now); nodes.push(osc,lfo);
    });
    // Heavy cave-echo thuds
    function thud(delay,freq,vol){
      const osc=ac.createOscillator(),g=ac.createGain();
      osc.type='sine'; osc.frequency.setValueAtTime(freq,now+delay);
      osc.frequency.exponentialRampToValueAtTime(freq*0.3,now+delay+0.5);
      g.gain.setValueAtTime(vol,now+delay); g.gain.exponentialRampToValueAtTime(0.0001,now+delay+0.6);
      osc.connect(g); g.connect(musicGain); osc.start(now+delay); osc.stop(now+delay+0.65);
    }
    // Irregular pattern
    const pat=[0,1.3,2.1,3.6,4.2,5.8,6.5,7.3,8.9,10.1,11.0,12.4,13.7,14.3,15.5,16.8,18.0,19.4,20.2,21.7,22.3,23.6,24.1,25.8,26.5,27.3,28.0,29.2,30.4,31.7];
    pat.forEach(t=>{ thud(t,45,0.12); thud(t+0.07,65,0.07); });
    // Grinding texture
    const dur2=32,bLen=Math.ceil(ac.sampleRate*dur2),b2=ac.createBuffer(1,bLen,ac.sampleRate),d2=b2.getChannelData(0);
    for(let i=0;i<bLen;i++) d2[i]=(Math.random()*2-1)*0.008;
    const src2=ac.createBufferSource(); src2.buffer=b2;
    const f2=ac.createBiquadFilter(); f2.type='lowpass'; f2.frequency.value=300;
    src2.connect(f2); f2.connect(musicGain); src2.start(now); nodes.push(src2);
    musicNode={nodes,gain:musicGain,startTime:now}; musicRunning=true;
  }

  // ‚îÄ‚îÄ STYLE 4: Intense Pulse (fast driving arpeggio + pounding kick) ‚îÄ‚îÄ
  function buildMusic_intense(){
    const ac = getCtx();
    musicGain = makeMusicGain(ac, 1.5);
    const nodes = [], now = ac.currentTime;
    // Driving arpeggio
    const bpm2=140,beat2=60/bpm2;
    const arpNotes=[110,138.6,165,220,277.2,330];
    for(let i=0;i<64;i++){
      const f=arpNotes[i%arpNotes.length];
      const osc=ac.createOscillator(),g=ac.createGain();
      osc.type='square'; osc.frequency.value=f;
      const t=now+i*beat2*0.5;
      g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(0.045,t+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001,t+beat2*0.45);
      osc.connect(g); g.connect(musicGain); osc.start(t); osc.stop(t+beat2*0.5);
    }
    // Pounding kick
    for(let bar=0;bar<16;bar++){
      const b=bar*beat2*4;
      [0,beat2,beat2*2,beat2*3].forEach(off=>{
        const osc=ac.createOscillator(),g=ac.createGain();
        osc.type='sine'; osc.frequency.setValueAtTime(120,now+b+off);
        osc.frequency.exponentialRampToValueAtTime(40,now+b+off+0.12);
        g.gain.setValueAtTime(0.1,now+b+off); g.gain.exponentialRampToValueAtTime(0.0001,now+b+off+0.15);
        osc.connect(g); g.connect(musicGain); osc.start(now+b+off); osc.stop(now+b+off+0.18);
      });
    }
    // Bass grind
    [55,110].forEach(f=>{
      const osc=ac.createOscillator(),g=ac.createGain(),lfo=ac.createOscillator(),lfoG=ac.createGain();
      osc.type='sawtooth'; osc.frequency.value=f;
      lfo.type='sine'; lfo.frequency.value=0.5;
      lfoG.gain.value=0.03; lfo.connect(lfoG); lfoG.connect(g.gain);
      g.gain.value=0.05; osc.connect(g); g.connect(musicGain);
      osc.start(now); lfo.start(now); nodes.push(osc,lfo);
    });
    musicNode={nodes,gain:musicGain,startTime:now}; musicRunning=true;
  }

  // ‚îÄ‚îÄ STYLE 5: Mystical (ethereal bells + airy pads) ‚îÄ‚îÄ
  function buildMusic_mystical(){
    const ac = getCtx();
    musicGain = makeMusicGain(ac, 5);
    const nodes = [], now = ac.currentTime;
    // Bell-like pentatonic chimes (scheduled)
    const penta=[261.6,293.7,329.6,392,440,523.3,587.3,659.3,784,880];
    for(let i=0;i<48;i++){
      const f=penta[Math.floor(Math.random()*penta.length)]*(Math.random()<0.3?2:1);
      const t=now+Math.random()*40+i*0.7;
      const osc=ac.createOscillator(),g=ac.createGain();
      osc.type='sine'; osc.frequency.value=f;
      g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(0.032,t+0.015);
      g.gain.exponentialRampToValueAtTime(0.0001,t+1.8+Math.random()*1.2);
      osc.connect(g); g.connect(musicGain); osc.start(t); osc.stop(t+2.5);
    }
    // Airy pads
    [130,196,261,392,523].forEach((f,i)=>{
      const osc=ac.createOscillator(),g=ac.createGain(),lfo=ac.createOscillator(),lfoG=ac.createGain();
      osc.type='sine'; osc.frequency.value=f;
      lfo.type='sine'; lfo.frequency.value=0.05+i*0.02;
      lfoG.gain.value=0.015; lfo.connect(lfoG); lfoG.connect(g.gain);
      g.gain.value=0.02; osc.connect(g); g.connect(musicGain);
      osc.start(now); lfo.start(now); nodes.push(osc,lfo);
    });
    // Wind breath noise
    const durM=45,bLenM=Math.ceil(ac.sampleRate*durM),bM=ac.createBuffer(1,bLenM,ac.sampleRate),dM=bM.getChannelData(0);
    for(let i=0;i<bLenM;i++) dM[i]=(Math.random()*2-1)*0.006;
    const srcM=ac.createBufferSource(); srcM.buffer=bM;
    const fM=ac.createBiquadFilter(); fM.type='highpass'; fM.frequency.value=2000;
    srcM.connect(fM); fM.connect(musicGain); srcM.start(now); nodes.push(srcM);
    musicNode={nodes,gain:musicGain,startTime:now}; musicRunning=true;
  }

  function buildMusic(){
    if(currentMusicStyle==='off') return;
    const builders={epic:buildMusic_epic,ambient:buildMusic_ambient,dungeon:buildMusic_dungeon,intense:buildMusic_intense,mystical:buildMusic_mystical};
    (builders[currentMusicStyle]||buildMusic_epic)();
  }

  function stopAllMusic(){
    if(!musicNode) return;
    const ac = getCtx();
    try{
      musicNode.gain.gain.setValueAtTime(musicNode.gain.gain.value, ac.currentTime);
      musicNode.gain.gain.linearRampToValueAtTime(0, ac.currentTime+0.4);
      musicNode.nodes.forEach(n=>{ try{n.stop(ac.currentTime+0.5);}catch(e){} });
    } catch(e){}
    musicNode = null;
    musicRunning = false;
  }

  return {
    play(name){
      if(muted) return;
      try{ sounds[name] && sounds[name](); } catch(e){}
    },
    startMusic(){
      if(muted) return;
      stopAllMusic();
      try{ buildMusic(); } catch(e){}
    },
    stopMusic(){
      try{ stopAllMusic(); } catch(e){}
    },
    pauseMusic(){
      if(musicGain && ctx){
        try{
          musicGain.gain.setValueAtTime(musicGain.gain.value, ctx.currentTime);
          musicGain.gain.linearRampToValueAtTime(0, ctx.currentTime+0.3);
        } catch(e){}
      }
    },
    resumeMusic(){
      if(muted) return;
      if(musicGain && ctx){
        try{
          musicGain.gain.setValueAtTime(musicGain.gain.value, ctx.currentTime);
          musicGain.gain.linearRampToValueAtTime(VOL.music * VOL.master, ctx.currentTime+0.4);
        } catch(e){}
      } else {
        // music was never started or was fully stopped
        try{ buildMusic(); } catch(e){}
      }
    },
    toggleMute(){
      muted = !muted;
      const btn = document.getElementById('sound-btn');
      const lbl = document.getElementById('sound-lbl');
      if(muted){
        stopAllMusic();
        btn.classList.add('muted');
        btn.innerHTML = 'üîá <span id="sound-lbl">MUTED</span>';
      } else {
        btn.classList.remove('muted');
        btn.innerHTML = 'üîä <span id="sound-lbl">SFX ON</span>';
        // restart music if game is running
        if(running && !paused) try{ buildMusic(); } catch(e){}
      }
    },
    setStyle(style){
      currentMusicStyle = style;
      if(style === 'off'){
        stopAllMusic();
      } else if(running && !paused && !muted){
        stopAllMusic();
        try{ buildMusic(); } catch(e){}
      }
    },
    // Hover sound ‚Äî call from mouseover on buttons (throttled)
    hover(){
      if(muted) return;
      const now = Date.now();
      if(now - _hoverThrottle < 80) return;
      _hoverThrottle = now;
      try{ sounds.hover(); } catch(e){}
    },
  };
})();

// ---- Attach hover sounds to all interactive elements ----
document.addEventListener('mouseover', e=>{
  const t = e.target;
  if(t.matches('button,.cs-card,.ndot,.nbtn,.p-btn,.help-close-btn,.g-btn')){
    SFX.hover();
  }
});

// =====================================================
// ‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
// ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó
// ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù
// ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïù
// ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë
// ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù
// =====================================================
let _helpFromPause = false;

function openHelp(){
  _helpFromPause = document.getElementById('pause-overlay').classList.contains('show');
  // if opened from pause menu, hide pause temporarily
  if(_helpFromPause) document.getElementById('pause-overlay').classList.remove('show');
  document.getElementById('help-overlay').classList.add('show');
  SFX.play('ui');
}

function closeHelp(){
  document.getElementById('help-overlay').classList.remove('show');
  SFX.play('ui');
  // restore pause menu if we came from there
  if(_helpFromPause){
    document.getElementById('pause-overlay').classList.add('show');
    _helpFromPause = false;
  }
}
// ---- END OF PATCHES ----

// =====================================================
// MUSIC STYLE SELECTOR
// =====================================================
const MUSIC_STYLES = {
  epic:     { label:'EPIC',     id:'mopt-epic' },
  ambient:  { label:'AMBIENT',  id:'mopt-ambient' },
  dungeon:  { label:'DUNGEON',  id:'mopt-dungeon' },
  intense:  { label:'INTENSE',  id:'mopt-intense' },
  mystical: { label:'MYSTICAL', id:'mopt-mystical' },
  off:      { label:'MUSIC OFF',id:'mopt-off' },
};

function toggleMusicPanel(){
  const panel = document.getElementById('music-panel');
  panel.classList.toggle('open');
}

function setMusicStyle(style){
  // Update active button
  Object.values(MUSIC_STYLES).forEach(s=>{
    const el = document.getElementById(s.id);
    if(el) el.classList.remove('active');
  });
  const activeEl = document.getElementById(MUSIC_STYLES[style]?.id);
  if(activeEl) activeEl.classList.add('active');

  // Update button label
  const lbl = document.getElementById('music-lbl');
  if(lbl) lbl.textContent = MUSIC_STYLES[style]?.label || 'MUSIC';

  // Apply change
  SFX.setStyle(style);
  SFX.play('ui');

  // Close panel
  document.getElementById('music-panel').classList.remove('open');
}

// Close music panel when clicking outside
document.addEventListener('click', e=>{
  const panel = document.getElementById('music-panel');
  const btn = document.getElementById('music-btn');
  if(panel.classList.contains('open') && !panel.contains(e.target) && e.target !== btn && !btn.contains(e.target)){
    panel.classList.remove('open');
  }
});
</script>
</body>
</html>
